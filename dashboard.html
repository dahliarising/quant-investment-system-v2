<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
    <title>Quant Investment System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
:root {
    --bg: #1a1a2e; --bg-card: #16213e; --bg-card2: #1a2540; --bg-hover: #1e2d4a;
    --border: #2a3a5c; --border-light: #334155;
    --orange: #e8793a; --orange-light: #f4a261; --orange-dark: #d4622a;
    --orange-glow: rgba(232,121,58,0.15); --orange-glow2: rgba(232,121,58,0.08);
    --accent: #f4a261; --success: #2dd4a8; --danger: #ff6b6b; --warning: #ffd166;
    --info: #4fc3f7; --purple: #a78bfa; --pink: #f472b6; --cyan: #22d3ee;
    --text: #e8e0d8; --text2: #b8a99a; --text3: #7a6f63; --text-dim: #5a5050;
    --glass: rgba(22,33,62,0.85);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
    font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
    background: var(--bg); color: var(--text); min-height:100vh;
    background-image: radial-gradient(ellipse at 20% 50%, rgba(232,121,58,0.04) 0%, transparent 50%),
                      radial-gradient(ellipse at 80% 20%, rgba(164,120,255,0.03) 0%, transparent 50%);
    padding-bottom: env(safe-area-inset-bottom,0);
}
::-webkit-scrollbar{width:5px} ::-webkit-scrollbar-track{background:var(--bg)} ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

.app{max-width:1200px;margin:0 auto;padding:1rem;padding-bottom:5.5rem;}
.page{display:none;animation:fadeIn .3s ease} .page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* Header */
.header{
    background:linear-gradient(135deg, #2a1810 0%, #1a1a2e 40%, #16213e 100%);
    border:1px solid var(--border); border-bottom:2px solid var(--orange);
    padding:1rem 1.25rem; border-radius:16px; margin-bottom:1rem;
    display:flex; justify-content:space-between; align-items:center;
}
.header h1{color:var(--orange);font-size:1.15rem;font-weight:800;letter-spacing:-0.3px}
.header p{color:var(--text3);font-size:.7rem;margin-top:.1rem}
.header-right{display:flex;gap:.4rem}

/* Tab Bar */
.tab-bar{
    position:fixed;bottom:0;left:0;right:0;
    background:rgba(22,33,62,0.97);backdrop-filter:blur(20px);
    display:flex;justify-content:space-around;align-items:center;
    padding:.4rem 0;padding-bottom:calc(.4rem + env(safe-area-inset-bottom,0));
    border-top:1px solid var(--border);z-index:1000;
}
.tab-item{
    display:flex;flex-direction:column;align-items:center;gap:.15rem;
    padding:.35rem .6rem;border-radius:10px;cursor:pointer;
    transition:all .2s;-webkit-tap-highlight-color:transparent;
    touch-action:manipulation;border:none;background:none;
    color:var(--text3);font-size:.6rem;font-weight:600;
}
.tab-item i{font-size:1.1rem;transition:all .2s}
.tab-item.active{color:var(--orange)}
.tab-item.active i{transform:scale(1.15);filter:drop-shadow(0 0 6px rgba(232,121,58,0.4))}

/* Cards */
.card{
    background:var(--bg-card);border:1px solid var(--border);
    border-radius:14px;padding:1.1rem;margin-bottom:.85rem;
    box-shadow:0 2px 12px rgba(0,0,0,0.2);
}
.card-title{
    font-size:.9rem;font-weight:700;color:var(--text);
    margin-bottom:.65rem;display:flex;align-items:center;gap:.45rem;
}
.card-title i{color:var(--orange);font-size:.85rem}

/* Summary */
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:.85rem}
.summary-item{
    background:var(--bg-card);border:1px solid var(--border);
    border-radius:12px;padding:.85rem;position:relative;overflow:hidden;
}
.summary-item::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%}
.summary-item.orange::before{background:var(--orange)} .summary-item.green::before{background:var(--success)}
.summary-item.red::before{background:var(--danger)} .summary-item.purple::before{background:var(--purple)}
.summary-item.blue::before{background:var(--info)} .summary-item.cyan::before{background:var(--cyan)}
.summary-label{font-size:.65rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.summary-value{font-size:1.25rem;font-weight:800;margin-top:.2rem}

/* Regime Badge */
.regime{display:inline-flex;align-items:center;gap:4px;padding:.25rem .7rem;border-radius:20px;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.regime-normal{background:rgba(45,212,168,0.12);color:var(--success);border:1px solid rgba(45,212,168,0.3)}
.regime-warning{background:rgba(255,209,102,0.12);color:var(--warning);border:1px solid rgba(255,209,102,0.3)}
.regime-breakdown{background:rgba(255,107,107,0.12);color:var(--danger);border:1px solid rgba(255,107,107,0.3)}

/* Stock Items */
.stock-item{
    display:flex;justify-content:space-between;align-items:center;
    padding:.75rem 0;border-bottom:1px solid rgba(42,58,92,0.5);
    cursor:pointer;-webkit-tap-highlight-color:transparent;
}
.stock-item:last-child{border-bottom:none}
.stock-left{display:flex;align-items:center;gap:.65rem}
.stock-icon{
    width:38px;height:38px;border-radius:10px;display:flex;
    align-items:center;justify-content:center;font-weight:800;
    font-size:.6rem;color:white;
    background:linear-gradient(135deg,var(--orange),var(--orange-dark));
    box-shadow:0 2px 8px rgba(232,121,58,0.25);
}
.stock-name{font-weight:600;font-size:.85rem;color:var(--text)}
.stock-sub{font-size:.7rem;color:var(--text3);margin-top:.05rem}
.stock-right{text-align:right}
.stock-price{font-weight:700;font-size:.9rem}
.stock-change{font-size:.75rem;font-weight:600}
.up{color:var(--danger)} .down{color:var(--info)}

/* Buttons */
.btn{
    padding:.5rem 1rem;border-radius:10px;border:none;font-weight:600;
    cursor:pointer;font-size:.8rem;display:inline-flex;align-items:center;
    gap:.35rem;transition:all .2s;-webkit-tap-highlight-color:transparent;
    touch-action:manipulation;
}
.btn-sm{padding:.35rem .7rem;font-size:.7rem;border-radius:8px}
.btn-primary{background:linear-gradient(135deg,var(--orange),var(--orange-dark));color:white;box-shadow:0 2px 10px rgba(232,121,58,0.3)}
.btn-primary:active{transform:scale(0.97)}
.btn-outline{background:transparent;border:1.5px solid var(--border);color:var(--text2)}
.btn-ghost{background:rgba(232,121,58,0.1);color:var(--orange);border:1px solid rgba(232,121,58,0.2)}
.btn-danger{background:var(--danger);color:white}

/* Badges */
.badge{display:inline-block;padding:.15rem .5rem;border-radius:20px;font-size:.65rem;font-weight:700}
.badge-strong{background:rgba(45,212,168,0.12);color:var(--success);border:1px solid rgba(45,212,168,0.25)}
.badge-buy{background:rgba(79,195,247,0.12);color:var(--info);border:1px solid rgba(79,195,247,0.25)}
.badge-hold{background:rgba(255,209,102,0.12);color:var(--warning);border:1px solid rgba(255,209,102,0.25)}

/* P&L */
.pnl-pos{color:var(--danger)} .pnl-neg{color:var(--info)}

/* Portfolio Item */
.portfolio-item{padding:.85rem 0;border-bottom:1px solid rgba(42,58,92,0.5)}
.portfolio-item:last-child{border-bottom:none}
.portfolio-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem}
.portfolio-details{
    display:grid;grid-template-columns:repeat(3,1fr);gap:.4rem;
    background:var(--bg-card2);padding:.5rem;border-radius:8px;font-size:.7rem;
}
.detail-label{color:var(--text3)} .detail-value{font-weight:700;margin-top:.05rem;color:var(--text2)}

/* Toast */
.toast{
    position:fixed;bottom:5rem;left:50%;transform:translateX(-50%) translateY(100px);
    background:var(--bg-card);color:var(--text);padding:.7rem 1.1rem;
    border:1px solid var(--border);
    border-radius:12px;font-size:.8rem;font-weight:500;z-index:9999;
    opacity:0;transition:all .4s;box-shadow:0 10px 40px rgba(0,0,0,.5);max-width:90vw;text-align:center;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{border-color:var(--success);background:rgba(45,212,168,0.1)}
.toast.error{border-color:var(--danger);background:rgba(255,107,107,0.1)}

/* Modal */
.modal-overlay{
    position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(8px);
    z-index:9000;display:flex;align-items:flex-end;justify-content:center;
    opacity:0;pointer-events:none;transition:opacity .3s;
}
.modal-overlay.show{opacity:1;pointer-events:auto}
.modal{
    background:var(--bg-card);border:1px solid var(--border);border-top:2px solid var(--orange);
    border-radius:18px 18px 0 0;padding:1.3rem;width:100%;max-width:500px;
    max-height:85vh;overflow-y:auto;transform:translateY(100%);transition:transform .3s;
}
.modal-overlay.show .modal{transform:translateY(0)}
.modal-handle{width:36px;height:3px;background:var(--border);border-radius:2px;margin:0 auto .85rem;display:block}
.modal h3{font-size:1rem;margin-bottom:.85rem;color:var(--text)}
.form-group{margin-bottom:.85rem}
.form-group label{display:block;font-size:.75rem;font-weight:600;color:var(--text3);margin-bottom:.25rem}
.form-group input,.form-group select{
    width:100%;padding:.6rem;border:1.5px solid var(--border);background:var(--bg);
    color:var(--text);border-radius:10px;font-size:.85rem;font-family:inherit;-webkit-appearance:none;
}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--orange)}

/* Empty */
.empty-state{text-align:center;padding:2.5rem 1rem;color:var(--text3)}
.empty-state i{font-size:2.5rem;margin-bottom:.75rem;opacity:.3;color:var(--orange)}
.empty-state p{font-size:.85rem}

/* Settings */
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:.85rem 0;border-bottom:1px solid rgba(42,58,92,0.5)}
.setting-row:last-child{border-bottom:none}
.setting-label{font-weight:600;font-size:.85rem;color:var(--text)} .setting-desc{font-size:.7rem;color:var(--text3);margin-top:.1rem}

/* Screener filters */
.filter-row{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.75rem}
.filter-chip{
    padding:.3rem .7rem;border-radius:20px;font-size:.7rem;font-weight:600;
    cursor:pointer;border:1px solid var(--border);color:var(--text2);
    background:var(--bg);transition:all .2s;-webkit-tap-highlight-color:transparent;
}
.filter-chip.active{border-color:var(--orange);color:var(--orange);background:rgba(232,121,58,0.08)}

/* Heatmap cell */
.heatmap-grid{display:grid;gap:2px;font-size:.65rem;text-align:center}
.heatmap-cell{padding:.4rem .2rem;border-radius:4px;font-weight:600}

/* Trade log */
.trade-row{display:flex;justify-content:space-between;align-items:center;padding:.6rem 0;border-bottom:1px solid rgba(42,58,92,.3);font-size:.8rem}
.trade-row:last-child{border-bottom:none}

/* Responsive */
@media(min-width:768px){
    .app{padding:1.5rem;padding-bottom:5.5rem}
    .summary-grid{grid-template-columns:repeat(3,1fr)}
    .portfolio-details{grid-template-columns:repeat(6,1fr)}
    .header h1{font-size:1.4rem}
    .metrics-5{grid-template-columns:repeat(5,1fr)}
}
@media(min-width:1024px){
    .summary-grid{grid-template-columns:repeat(5,1fr)}
}
@media(max-width:380px){
    .app{padding:.4rem;padding-bottom:5rem}
    .summary-value{font-size:1.05rem} .header h1{font-size:1rem}
    .tab-item{font-size:.55rem;padding:.3rem .4rem} .tab-item i{font-size:1rem}
}
    </style>
</head>
<body>
<div class="app">
    <div class="header">
        <div>
            <h1><i class="fas fa-chart-line" style="margin-right:4px"></i> Quant System</h1>
            <p>AI Multi-Factor & ML Hybrid Platform</p>
        </div>
        <div class="header-right">
            <span id="dataStatus" style="font-size:.6rem;padding:.2rem .5rem;border-radius:12px;font-weight:700;letter-spacing:.5px;display:inline-flex;align-items:center;gap:3px;margin-right:.3rem"></span>
            <button class="btn btn-ghost btn-sm" onclick="refreshPrices()" title="Refresh prices"><i class="fas fa-sync-alt" id="refreshIcon"></i></button>
            <button class="btn btn-ghost btn-sm" onclick="exportData()"><i class="fas fa-download"></i></button>
            <button class="btn btn-primary btn-sm" onclick="runStrategy()"><i class="fas fa-rocket"></i> Run</button>
        </div>
    </div>

    <!-- ===== PAGE: Dashboard ===== -->
    <div id="page-dashboard" class="page active">
        <div class="summary-grid" id="dashSummary"></div>
        <div class="card"><div class="card-title"><i class="fas fa-chart-area"></i> Portfolio Performance</div><div id="perfChart" style="height:220px"></div></div>
        <div class="card"><div class="card-title"><i class="fas fa-chart-line"></i> Drawdown</div><div id="ddChart" style="height:140px"></div></div>
        <div class="card"><div class="card-title"><i class="fas fa-calendar-alt"></i> Monthly Returns</div><div id="monthlyChart" style="height:180px"></div></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
            <div class="card"><div class="card-title"><i class="fas fa-chart-pie"></i> Sectors</div><div id="sectorChart" style="height:200px"></div></div>
            <div class="card"><div class="card-title"><i class="fas fa-trophy"></i> Top Movers</div><div id="topMovers"></div></div>
        </div>
    </div>

    <!-- ===== PAGE: Portfolio ===== -->
    <div id="page-portfolio" class="page">
        <div class="card">
            <div class="card-title" style="justify-content:space-between">
                <span><i class="fas fa-wallet"></i> My Portfolio</span>
                <button class="btn btn-primary btn-sm" onclick="openAddModal()"><i class="fas fa-plus"></i> Add</button>
            </div>
            <div id="portfolioList"></div>
        </div>
    </div>

    <!-- ===== PAGE: Signals ===== -->
    <div id="page-signals" class="page">
        <div class="card">
            <div class="card-title"><i class="fas fa-bolt"></i> AI Buy Signals</div>
            <p style="font-size:.75rem;color:var(--text3);margin-bottom:.75rem">Multi-factor + ML model recommendations. Tap for details.</p>
            <div id="signalsList"></div>
        </div>
        <div class="card"><div class="card-title"><i class="fas fa-fire"></i> Factor Heatmap</div><div id="heatmapChart" style="height:280px"></div></div>
        <div class="card"><div class="card-title"><i class="fas fa-chart-bar"></i> Factor Scores</div><div id="factorChart" style="height:220px"></div></div>
    </div>

    <!-- ===== PAGE: Screener ===== -->
    <div id="page-screener" class="page">
        <!-- Ticker Search -->
        <div class="card">
            <div class="card-title"><i class="fas fa-crosshairs"></i> Ticker Lookup & Prediction</div>
            <div style="display:flex;gap:.5rem;margin-bottom:.6rem">
                <input type="text" id="searchTicker" placeholder="Enter ticker (e.g. PLTR, SOFI, RIVN...)" autocomplete="off"
                    style="flex:1;padding:.6rem .8rem;border:1.5px solid var(--border);background:var(--bg);color:var(--text);border-radius:10px;font-size:.85rem;font-family:inherit;-webkit-appearance:none"
                    onkeydown="if(event.key==='Enter')searchStock()">
                <button class="btn btn-primary" onclick="searchStock()"><i class="fas fa-search"></i> Analyze</button>
            </div>
            <div id="searchResult"></div>
        </div>
        <!-- Sector Screener -->
        <div class="card">
            <div class="card-title"><i class="fas fa-search-dollar"></i> Stock Screener <span style="font-size:.65rem;color:var(--text3);font-weight:400;margin-left:.3rem">(70 stocks, 7 sectors)</span></div>
            <div class="filter-row" id="screenerFilters"></div>
            <div id="screenerResults"></div>
        </div>
        <div class="card"><div class="card-title"><i class="fas fa-gem"></i> Hidden Champions</div>
            <p style="font-size:.75rem;color:var(--text3);margin-bottom:.6rem">Mid-cap stocks with strong momentum + quality factors</p>
            <div id="hiddenChampions"></div>
        </div>
    </div>

    <!-- ===== PAGE: Analysis ===== -->
    <div id="page-analysis" class="page">
        <div class="card"><div class="card-title"><i class="fas fa-microscope"></i> Return Distribution</div><div id="analysisChart" style="height:260px"></div></div>
        <div class="card"><div class="card-title"><i class="fas fa-balance-scale"></i> Risk Metrics</div><div id="riskMetrics"></div></div>
        <div class="card"><div class="card-title"><i class="fas fa-brain"></i> Feature Importance (SHAP)</div><div id="shapChart" style="height:280px"></div></div>
        <div class="card">
            <div class="card-title"><i class="fas fa-flask"></i> Scenario Analysis</div>
            <div id="scenarioSelector" style="margin-bottom:.6rem"></div>
            <div id="scenarioChart" style="height:250px"></div>
            <div id="scenarioSummary" style="margin-top:.6rem"></div>
        </div>
    </div>

    <!-- ===== PAGE: Trade Log ===== -->
    <div id="page-tradelog" class="page">
        <div class="card"><div class="card-title"><i class="fas fa-history"></i> Trade History</div><div id="tradeLog"></div></div>
        <div class="card"><div class="card-title"><i class="fas fa-bullseye"></i> Prediction Tracking</div><div id="predTracking"></div></div>
        <div class="card"><div class="card-title"><i class="fas fa-chart-line"></i> Model Accuracy</div><div id="accuracyChart" style="height:220px"></div></div>
    </div>

    <!-- ===== PAGE: Settings ===== -->
    <div id="page-settings" class="page">
        <div class="card">
            <div class="card-title"><i class="fas fa-sliders-h"></i> Strategy Parameters</div>
            <div class="form-group"><label>ML Model</label>
                <select id="setModel" onchange="saveSetting('model',this.value)">
                    <option value="lgbm">LightGBM</option><option value="xgb">XGBoost</option>
                    <option value="rf">Random Forest</option><option value="ridge">Ridge</option>
                </select></div>
            <div class="form-group"><label>Horizon</label>
                <select id="setHorizon" onchange="saveSetting('horizon',this.value)">
                    <option value="1y">1 Year</option><option value="30d">30 Days</option>
                </select></div>
            <div class="form-group"><label>Currency</label>
                <select id="setCurrency" onchange="saveSetting('currency',this.value)">
                    <option value="USD">USD ($)</option><option value="KRW">KRW (&#8361;)</option>
                </select></div>
        </div>
        <div class="card">
            <div class="card-title"><i class="fas fa-weight-hanging"></i> Factor Weights</div>
            <div class="form-group"><label>Momentum: <span id="wMomVal">0.25</span></label>
                <input type="range" id="wMom" min="0" max="1" step="0.05" value="0.25" oninput="updateWeight(this)" style="width:100%"></div>
            <div class="form-group"><label>Value: <span id="wValVal">0.25</span></label>
                <input type="range" id="wVal" min="0" max="1" step="0.05" value="0.25" oninput="updateWeight(this)" style="width:100%"></div>
            <div class="form-group"><label>Quality: <span id="wQualVal">0.25</span></label>
                <input type="range" id="wQual" min="0" max="1" step="0.05" value="0.25" oninput="updateWeight(this)" style="width:100%"></div>
            <div class="form-group"><label>Risk: <span id="wRiskVal">0.25</span></label>
                <input type="range" id="wRisk" min="0" max="1" step="0.05" value="0.25" oninput="updateWeight(this)" style="width:100%"></div>
        </div>
        <div class="card">
            <div class="card-title"><i class="fas fa-shield-alt"></i> Risk Controls</div>
            <div class="setting-row"><div><div class="setting-label">Max Position</div><div class="setting-desc">Single stock limit</div></div><span style="color:var(--orange);font-weight:700">15%</span></div>
            <div class="setting-row"><div><div class="setting-label">Max Sector</div><div class="setting-desc">Sector concentration limit</div></div><span style="color:var(--orange);font-weight:700">40%</span></div>
            <div class="setting-row"><div><div class="setting-label">Sector Neutral</div><div class="setting-desc">Neutralize sector bias</div></div><span style="color:var(--success);font-weight:700">ON</span></div>
        </div>
        <div class="card">
            <div class="card-title"><i class="fas fa-server"></i> System Info</div>
            <div style="font-size:.8rem;color:var(--text3);line-height:1.8">
                <p><strong style="color:var(--text2)">Hosting:</strong> GitHub Pages (Static)</p>
                <p><strong style="color:var(--text2)">Engine:</strong> Client-side (no server needed)</p>
                <p><strong style="color:var(--text2)">Market Data:</strong> Yahoo Finance (real-time)</p>
                <p><strong style="color:var(--text2)">Auto Refresh:</strong> Every 5min during US market hours</p>
                <p><strong style="color:var(--text2)">Storage:</strong> Browser localStorage + price cache</p>
                <p><strong style="color:var(--text2)">Architecture:</strong> Factor Scoring + ML + Regime Detection</p>
            </div>
            <button class="btn btn-danger btn-sm" style="margin-top:.75rem;width:100%" onclick="resetData()"><i class="fas fa-trash"></i> Reset All Data</button>
        </div>
    </div>
</div>

<!-- Tab Bar -->
<nav class="tab-bar">
    <button class="tab-item active" onclick="go('dashboard',this)"><i class="fas fa-th-large"></i><span>Home</span></button>
    <button class="tab-item" onclick="go('portfolio',this)"><i class="fas fa-wallet"></i><span>Portfolio</span></button>
    <button class="tab-item" onclick="go('signals',this)"><i class="fas fa-bolt"></i><span>Signals</span></button>
    <button class="tab-item" onclick="go('screener',this)"><i class="fas fa-search"></i><span>Screener</span></button>
    <button class="tab-item" onclick="go('analysis',this)"><i class="fas fa-flask"></i><span>Analysis</span></button>
    <button class="tab-item" onclick="go('tradelog',this)"><i class="fas fa-history"></i><span>Log</span></button>
    <button class="tab-item" onclick="go('settings',this)"><i class="fas fa-cog"></i><span>Settings</span></button>
</nav>

<div class="toast" id="toast"></div>

<!-- Add Stock Modal -->
<div class="modal-overlay" id="addModal">
    <div class="modal"><span class="modal-handle"></span>
        <h3><i class="fas fa-plus-circle" style="color:var(--orange)"></i> Add Stock</h3>
        <div class="form-group"><label>Symbol</label><input type="text" id="aSymbol" placeholder="AAPL" autocomplete="off"></div>
        <div class="form-group"><label>Name</label><input type="text" id="aName" placeholder="Apple Inc."></div>
        <div class="form-group"><label>Buy Price</label><input type="number" id="aBuy" placeholder="0" step="0.01"></div>
        <div class="form-group"><label>Quantity</label><input type="number" id="aQty" placeholder="0" step="1"></div>
        <div class="form-group"><label>Current Price</label><input type="number" id="aCur" placeholder="0" step="0.01"></div>
        <div class="form-group"><label>Sector</label>
            <select id="aSector"><option>Tech</option><option>Healthcare</option><option>Finance</option><option>Consumer</option><option>Energy</option><option>Industrial</option><option>Communication</option><option>Other</option></select></div>
        <div style="display:flex;gap:.6rem">
            <button class="btn btn-primary" style="flex:1" onclick="addStock()">Add</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeModals()">Cancel</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal"><span class="modal-handle"></span>
        <h3><i class="fas fa-edit" style="color:var(--orange)"></i> Update Stock</h3>
        <input type="hidden" id="eIdx">
        <div class="form-group"><label>Current Price</label><input type="number" id="eCur" step="0.01"></div>
        <div class="form-group"><label>Quantity</label><input type="number" id="eQty" step="1"></div>
        <div style="display:flex;gap:.6rem">
            <button class="btn btn-primary" style="flex:1" onclick="updateStock()">Update</button>
            <button class="btn btn-danger" style="flex:1" onclick="sellStock()"><i class="fas fa-sign-out-alt"></i> Sell</button>
        </div>
        <button class="btn btn-outline" style="width:100%;margin-top:.4rem" onclick="closeModals()">Cancel</button>
    </div>
</div>

<!-- Signal Modal -->
<div class="modal-overlay" id="sigModal">
    <div class="modal"><span class="modal-handle"></span>
        <h3 id="sigTitle">Detail</h3><div id="sigContent"></div>
        <button class="btn btn-primary" style="width:100%;margin-top:.75rem" id="sigAddBtn"><i class="fas fa-plus"></i> Add to Portfolio</button>
        <button class="btn btn-outline" style="width:100%;margin-top:.4rem" onclick="closeModals()">Close</button>
    </div>
</div>

<!-- Strategy Modal -->
<div class="modal-overlay" id="stratModal">
    <div class="modal"><span class="modal-handle"></span>
        <h3><i class="fas fa-rocket" style="color:var(--orange)"></i> Running Strategy</h3>
        <div style="width:100%;height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin:.75rem 0">
            <div id="progFill" style="height:100%;background:linear-gradient(90deg,var(--orange),var(--orange-light));border-radius:3px;width:0%;transition:width .3s"></div>
        </div>
        <div id="progText" style="font-size:.8rem;color:var(--text3);margin-bottom:.5rem">Initializing...</div>
        <div id="stratLog" style="font-family:monospace;font-size:.7rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:.6rem;max-height:160px;overflow-y:auto;color:var(--text3);line-height:1.8"></div>
    </div>
</div>

<script>
const SK='qis_port_v3', STK='qis_set_v3', TLK='qis_trades_v3', PCK='qis_prices_cache';
const plotDark={plot_bgcolor:'rgba(0,0,0,0)',paper_bgcolor:'rgba(0,0,0,0)',font:{family:'Inter',color:'#7a6f63',size:11},margin:{t:10,r:10,b:30,l:40}};

let isLive=false, lastUpdate=null, priceCache={};

// Signals data per sector (~10 each, fallback prices overwritten by real data)
const signals=[
    // Tech (10)
    {s:'NVDA',n:'NVIDIA',sec:'Tech',sc:.95,tp:0,cp:0,f:{mom:1.8,val:-0.5,qual:1.2,risk:-0.3},r:'AI/GPU demand, data center growth'},
    {s:'AAPL',n:'Apple',sec:'Tech',sc:.92,tp:0,cp:0,f:{mom:1.2,val:0.8,qual:1.5,risk:0.2},r:'Services growth, iPhone cycle'},
    {s:'MSFT',n:'Microsoft',sec:'Tech',sc:.89,tp:0,cp:0,f:{mom:0.9,val:0.3,qual:1.8,risk:0.1},r:'Azure + Copilot AI integration'},
    {s:'AVGO',n:'Broadcom',sec:'Tech',sc:.87,tp:0,cp:0,f:{mom:1.4,val:0.2,qual:1.6,risk:0.1},r:'AI networking, VMware synergy'},
    {s:'CRM',n:'Salesforce',sec:'Tech',sc:.83,tp:0,cp:0,f:{mom:0.8,val:0.6,qual:1.3,risk:0.2},r:'AI CRM, Data Cloud growth'},
    {s:'ADBE',n:'Adobe',sec:'Tech',sc:.81,tp:0,cp:0,f:{mom:0.5,val:0.4,qual:1.5,risk:0.3},r:'AI creative tools, Firefly'},
    {s:'AMD',n:'AMD',sec:'Tech',sc:.84,tp:0,cp:0,f:{mom:1.3,val:-0.3,qual:0.9,risk:-0.5},r:'AI chip competition, MI300'},
    {s:'ORCL',n:'Oracle',sec:'Tech',sc:.79,tp:0,cp:0,f:{mom:1.0,val:0.7,qual:1.1,risk:0.4},r:'Cloud infrastructure, OCI'},
    {s:'NOW',n:'ServiceNow',sec:'Tech',sc:.82,tp:0,cp:0,f:{mom:1.1,val:-0.4,qual:1.4,risk:0.0},r:'AI workflow automation'},
    {s:'INTC',n:'Intel',sec:'Tech',sc:.62,tp:0,cp:0,f:{mom:-1.2,val:1.5,qual:-0.8,risk:-1.5},r:'Foundry turnaround, 18A node'},
    // Healthcare (10)
    {s:'LLY',n:'Eli Lilly',sec:'Healthcare',sc:.88,tp:0,cp:0,f:{mom:1.5,val:-1.2,qual:0.8,risk:-0.5},r:'GLP-1 drug pipeline'},
    {s:'UNH',n:'UnitedHealth',sec:'Healthcare',sc:.81,tp:0,cp:0,f:{mom:0.3,val:0.9,qual:1.7,risk:0.5},r:'Medicare expansion'},
    {s:'JNJ',n:'Johnson & Johnson',sec:'Healthcare',sc:.78,tp:0,cp:0,f:{mom:0.1,val:1.2,qual:1.5,risk:0.9},r:'MedTech + pharma split'},
    {s:'ABBV',n:'AbbVie',sec:'Healthcare',sc:.80,tp:0,cp:0,f:{mom:0.6,val:1.0,qual:1.2,risk:0.3},r:'Immunology, Rinvoq growth'},
    {s:'MRK',n:'Merck',sec:'Healthcare',sc:.77,tp:0,cp:0,f:{mom:0.2,val:0.8,qual:1.3,risk:0.6},r:'Keytruda franchise'},
    {s:'TMO',n:'Thermo Fisher',sec:'Healthcare',sc:.79,tp:0,cp:0,f:{mom:0.4,val:0.3,qual:1.6,risk:0.2},r:'Life sciences tools leader'},
    {s:'ABT',n:'Abbott Labs',sec:'Healthcare',sc:.76,tp:0,cp:0,f:{mom:0.3,val:0.7,qual:1.4,risk:0.7},r:'Diagnostics + MedTech'},
    {s:'AMGN',n:'Amgen',sec:'Healthcare',sc:.74,tp:0,cp:0,f:{mom:0.5,val:0.9,qual:1.0,risk:0.4},r:'Obesity drug MariTide'},
    {s:'PFE',n:'Pfizer',sec:'Healthcare',sc:.65,tp:0,cp:0,f:{mom:-0.8,val:1.8,qual:0.5,risk:-0.3},r:'Post-COVID pipeline rebuild'},
    {s:'ISRG',n:'Intuitive Surgical',sec:'Healthcare',sc:.85,tp:0,cp:0,f:{mom:1.2,val:-0.9,qual:1.5,risk:-0.1},r:'Da Vinci 5 robot launch'},
    // Finance (10)
    {s:'JPM',n:'JPMorgan',sec:'Finance',sc:.80,tp:0,cp:0,f:{mom:0.5,val:1.5,qual:1.3,risk:0.8},r:'NII growth, investment banking'},
    {s:'V',n:'Visa',sec:'Finance',sc:.86,tp:0,cp:0,f:{mom:0.9,val:0.2,qual:1.8,risk:0.6},r:'Global payments leader'},
    {s:'MA',n:'Mastercard',sec:'Finance',sc:.85,tp:0,cp:0,f:{mom:0.8,val:0.1,qual:1.7,risk:0.5},r:'Cross-border recovery'},
    {s:'GS',n:'Goldman Sachs',sec:'Finance',sc:.78,tp:0,cp:0,f:{mom:0.7,val:1.3,qual:1.0,risk:-0.2},r:'Trading + asset mgmt'},
    {s:'BAC',n:'Bank of America',sec:'Finance',sc:.75,tp:0,cp:0,f:{mom:0.3,val:1.6,qual:0.8,risk:0.1},r:'Rate sensitivity, consumer'},
    {s:'MS',n:'Morgan Stanley',sec:'Finance',sc:.77,tp:0,cp:0,f:{mom:0.6,val:1.1,qual:1.1,risk:0.0},r:'Wealth management pivot'},
    {s:'BLK',n:'BlackRock',sec:'Finance',sc:.82,tp:0,cp:0,f:{mom:1.0,val:0.4,qual:1.5,risk:0.3},r:'ETF dominance, $10T+ AUM'},
    {s:'AXP',n:'American Express',sec:'Finance',sc:.79,tp:0,cp:0,f:{mom:0.8,val:0.7,qual:1.2,risk:0.2},r:'Premium consumer spend'},
    {s:'C',n:'Citigroup',sec:'Finance',sc:.70,tp:0,cp:0,f:{mom:0.2,val:1.8,qual:0.4,risk:-0.4},r:'Restructuring turnaround'},
    {s:'SCHW',n:'Schwab',sec:'Finance',sc:.76,tp:0,cp:0,f:{mom:0.4,val:1.0,qual:1.0,risk:0.1},r:'Brokerage + Ameritrade integration'},
    // Consumer (10)
    {s:'AMZN',n:'Amazon',sec:'Consumer',sc:.85,tp:0,cp:0,f:{mom:0.7,val:0.5,qual:1.0,risk:0.3},r:'AWS + retail margin expansion'},
    {s:'TSLA',n:'Tesla',sec:'Consumer',sc:.72,tp:0,cp:0,f:{mom:-0.3,val:-1.8,qual:0.2,risk:-1.2},r:'FSD progress, energy storage'},
    {s:'COST',n:'Costco',sec:'Consumer',sc:.83,tp:0,cp:0,f:{mom:1.0,val:-0.6,qual:1.6,risk:0.8},r:'Membership model, pricing power'},
    {s:'WMT',n:'Walmart',sec:'Consumer',sc:.80,tp:0,cp:0,f:{mom:0.8,val:0.3,qual:1.3,risk:0.9},r:'E-commerce + ad platform'},
    {s:'HD',n:'Home Depot',sec:'Consumer',sc:.78,tp:0,cp:0,f:{mom:0.4,val:0.6,qual:1.4,risk:0.4},r:'Housing cycle recovery'},
    {s:'MCD',n:'McDonald\'s',sec:'Consumer',sc:.76,tp:0,cp:0,f:{mom:0.2,val:0.5,qual:1.5,risk:0.7},r:'Digital ordering, loyalty program'},
    {s:'NKE',n:'Nike',sec:'Consumer',sc:.68,tp:0,cp:0,f:{mom:-0.7,val:0.8,qual:0.9,risk:-0.3},r:'Brand refresh, DTC recovery'},
    {s:'SBUX',n:'Starbucks',sec:'Consumer',sc:.71,tp:0,cp:0,f:{mom:-0.2,val:0.6,qual:1.0,risk:0.1},r:'New CEO turnaround plan'},
    {s:'PG',n:'Procter & Gamble',sec:'Consumer',sc:.77,tp:0,cp:0,f:{mom:0.3,val:0.4,qual:1.6,risk:1.0},r:'Pricing power, staples leader'},
    {s:'TGT',n:'Target',sec:'Consumer',sc:.69,tp:0,cp:0,f:{mom:-0.4,val:1.2,qual:0.7,risk:-0.1},r:'Discretionary recovery play'},
    // Communication (10)
    {s:'META',n:'Meta',sec:'Communication',sc:.83,tp:0,cp:0,f:{mom:1.3,val:1.1,qual:0.6,risk:-0.2},r:'Ad recovery, Reels monetization'},
    {s:'GOOG',n:'Alphabet',sec:'Communication',sc:.86,tp:0,cp:0,f:{mom:0.9,val:1.0,qual:1.4,risk:0.3},r:'Search AI, Cloud, YouTube'},
    {s:'NFLX',n:'Netflix',sec:'Communication',sc:.84,tp:0,cp:0,f:{mom:1.4,val:-0.3,qual:1.1,risk:0.1},r:'Ad tier growth, live sports'},
    {s:'DIS',n:'Disney',sec:'Communication',sc:.73,tp:0,cp:0,f:{mom:0.1,val:0.7,qual:0.8,risk:-0.2},r:'Streaming profit, parks'},
    {s:'CMCSA',n:'Comcast',sec:'Communication',sc:.71,tp:0,cp:0,f:{mom:-0.2,val:1.4,qual:0.9,risk:0.5},r:'Broadband + Peacock'},
    {s:'TMUS',n:'T-Mobile',sec:'Communication',sc:.79,tp:0,cp:0,f:{mom:0.7,val:0.5,qual:1.2,risk:0.6},r:'5G subscriber growth'},
    {s:'SPOT',n:'Spotify',sec:'Communication',sc:.81,tp:0,cp:0,f:{mom:1.5,val:-0.8,qual:0.7,risk:-0.4},r:'Margin expansion, price hikes'},
    {s:'T',n:'AT&T',sec:'Communication',sc:.68,tp:0,cp:0,f:{mom:0.0,val:1.6,qual:0.5,risk:0.3},r:'Fiber + 5G, debt reduction'},
    {s:'ROKU',n:'Roku',sec:'Communication',sc:.66,tp:0,cp:0,f:{mom:-0.5,val:0.3,qual:0.3,risk:-0.8},r:'CTV platform, ad recovery'},
    {s:'RBLX',n:'Roblox',sec:'Communication',sc:.70,tp:0,cp:0,f:{mom:0.6,val:-1.5,qual:-0.2,risk:-0.9},r:'Metaverse gaming, user growth'},
    // Energy (10)
    {s:'XOM',n:'ExxonMobil',sec:'Energy',sc:.78,tp:0,cp:0,f:{mom:0.4,val:1.3,qual:1.1,risk:0.6},r:'Pioneer acquisition, Permian'},
    {s:'CVX',n:'Chevron',sec:'Energy',sc:.76,tp:0,cp:0,f:{mom:0.3,val:1.2,qual:1.0,risk:0.5},r:'Hess merger, Guyana'},
    {s:'COP',n:'ConocoPhillips',sec:'Energy',sc:.77,tp:0,cp:0,f:{mom:0.5,val:1.1,qual:1.2,risk:0.3},r:'Low-cost production'},
    {s:'SLB',n:'Schlumberger',sec:'Energy',sc:.74,tp:0,cp:0,f:{mom:0.2,val:0.9,qual:0.8,risk:-0.1},r:'Oilfield services leader'},
    {s:'EOG',n:'EOG Resources',sec:'Energy',sc:.75,tp:0,cp:0,f:{mom:0.3,val:1.0,qual:1.3,risk:0.4},r:'Premium drilling returns'},
    {s:'MPC',n:'Marathon Petroleum',sec:'Energy',sc:.73,tp:0,cp:0,f:{mom:0.6,val:1.4,qual:0.7,risk:-0.2},r:'Refining margins'},
    {s:'OXY',n:'Occidental',sec:'Energy',sc:.71,tp:0,cp:0,f:{mom:-0.1,val:1.0,qual:0.6,risk:-0.5},r:'Berkshire-backed, carbon capture'},
    {s:'WMB',n:'Williams Companies',sec:'Energy',sc:.72,tp:0,cp:0,f:{mom:0.4,val:0.8,qual:0.9,risk:0.7},r:'Natural gas pipelines'},
    {s:'PSX',n:'Phillips 66',sec:'Energy',sc:.70,tp:0,cp:0,f:{mom:0.1,val:1.3,qual:0.7,risk:0.0},r:'Refining + midstream'},
    {s:'LNG',n:'Cheniere Energy',sec:'Energy',sc:.79,tp:0,cp:0,f:{mom:0.7,val:0.6,qual:1.1,risk:0.2},r:'LNG export dominance'},
    // Industrial (10)
    {s:'CAT',n:'Caterpillar',sec:'Industrial',sc:.80,tp:0,cp:0,f:{mom:0.8,val:0.7,qual:1.3,risk:0.3},r:'Infrastructure spending cycle'},
    {s:'GE',n:'GE Aerospace',sec:'Industrial',sc:.83,tp:0,cp:0,f:{mom:1.3,val:0.2,qual:1.2,risk:0.1},r:'Aviation aftermarket growth'},
    {s:'HON',n:'Honeywell',sec:'Industrial',sc:.77,tp:0,cp:0,f:{mom:0.3,val:0.6,qual:1.4,risk:0.5},r:'Automation + aerospace'},
    {s:'UNP',n:'Union Pacific',sec:'Industrial',sc:.76,tp:0,cp:0,f:{mom:0.2,val:0.8,qual:1.5,risk:0.7},r:'Rail network efficiency'},
    {s:'RTX',n:'RTX Corp',sec:'Industrial',sc:.78,tp:0,cp:0,f:{mom:0.6,val:0.5,qual:1.1,risk:0.4},r:'Defense + Pratt & Whitney'},
    {s:'LMT',n:'Lockheed Martin',sec:'Industrial',sc:.79,tp:0,cp:0,f:{mom:0.5,val:0.9,qual:1.3,risk:0.8},r:'Defense spending, F-35'},
    {s:'DE',n:'Deere',sec:'Industrial',sc:.75,tp:0,cp:0,f:{mom:0.1,val:0.7,qual:1.4,risk:0.2},r:'Precision agriculture tech'},
    {s:'BA',n:'Boeing',sec:'Industrial',sc:.63,tp:0,cp:0,f:{mom:-0.8,val:-0.5,qual:-0.6,risk:-1.3},r:'Production recovery, 737 MAX'},
    {s:'ETN',n:'Eaton Corp',sec:'Industrial',sc:.82,tp:0,cp:0,f:{mom:1.2,val:0.1,qual:1.3,risk:0.2},r:'Electrification megatrend'},
    {s:'UBER',n:'Uber',sec:'Industrial',sc:.81,tp:0,cp:0,f:{mom:1.1,val:-0.2,qual:0.8,risk:-0.1},r:'Mobility + delivery profitability'},
];

// Hidden champions (mid-cap with strong factors)
const hiddenGems=[
    {s:'CRWD',n:'CrowdStrike',sec:'Tech',sc:.88,cp:0,mom:1.6,qual:1.3,r:'Cybersecurity leader'},
    {s:'DDOG',n:'Datadog',sec:'Tech',sc:.84,cp:0,mom:1.2,qual:0.9,r:'Observability platform'},
    {s:'MELI',n:'MercadoLibre',sec:'Consumer',sc:.82,cp:0,mom:1.4,qual:1.1,r:'LatAm e-commerce'},
    {s:'TTD',n:'Trade Desk',sec:'Tech',sc:.79,cp:0,mom:0.8,qual:1.0,r:'Programmatic ads'},
    {s:'HUBS',n:'HubSpot',sec:'Tech',sc:.77,cp:0,mom:0.6,qual:0.8,r:'SMB marketing'},
    {s:'PANW',n:'Palo Alto',sec:'Tech',sc:.86,cp:0,mom:1.3,qual:1.2,r:'Platformization, AI security'},
    {s:'SNOW',n:'Snowflake',sec:'Tech',sc:.75,cp:0,mom:0.4,qual:0.7,r:'Data cloud, AI features'},
    {s:'COIN',n:'Coinbase',sec:'Finance',sc:.71,cp:0,mom:1.8,qual:0.3,r:'Crypto exchange, Base L2'},
    {s:'ABNB',n:'Airbnb',sec:'Consumer',sc:.76,cp:0,mom:0.5,qual:1.0,r:'Travel demand, experiences'},
    {s:'PLTR',n:'Palantir',sec:'Tech',sc:.80,cp:0,mom:1.7,qual:0.5,r:'AI/ML platform, gov + commercial'},
];

// ===== Real-time Price Fetching =====
const ALL_TICKERS=[...signals.map(s=>s.s),...hiddenGems.map(h=>h.s)];

function updateDataStatus(status,msg){
    const el=document.getElementById('dataStatus');
    if(status==='live'){el.innerHTML='<i class="fas fa-circle" style="font-size:5px;color:#2dd4a8"></i> LIVE';el.style.background='rgba(45,212,168,0.12)';el.style.color='#2dd4a8';el.style.border='1px solid rgba(45,212,168,0.3)';el.title='Last: '+(lastUpdate?lastUpdate.toLocaleTimeString():'');}
    else if(status==='loading'){el.innerHTML='<i class="fas fa-spinner fa-spin" style="font-size:7px"></i> Loading';el.style.background='rgba(232,121,58,0.12)';el.style.color='var(--orange)';el.style.border='1px solid rgba(232,121,58,0.3)';}
    else if(status==='cached'){el.innerHTML='<i class="fas fa-database" style="font-size:5px"></i> CACHED';el.style.background='rgba(79,195,247,0.12)';el.style.color='var(--info)';el.style.border='1px solid rgba(79,195,247,0.3)';el.title=msg||'';}
    else{el.innerHTML='<i class="fas fa-exclamation-triangle" style="font-size:5px"></i> OFFLINE';el.style.background='rgba(255,107,107,0.12)';el.style.color='var(--danger)';el.style.border='1px solid rgba(255,107,107,0.3)';}
}

async function fetchPricesFromYahoo(tickers){
    // Yahoo Finance v8 chart endpoint via CORS proxies
    const proxies=[
        url=>`https://corsproxy.io/?${encodeURIComponent(url)}`,
        url=>`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    ];
    const yahooUrl=`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${tickers.join(',')}&fields=regularMarketPrice,regularMarketChange,regularMarketChangePercent,regularMarketPreviousClose,shortName`;

    for(const proxy of proxies){
        try{
            const res=await fetch(proxy(yahooUrl),{signal:AbortSignal.timeout(8000)});
            if(!res.ok)continue;
            const data=await res.json();
            if(data.quoteResponse&&data.quoteResponse.result){
                const prices={};
                data.quoteResponse.result.forEach(q=>{
                    prices[q.symbol]={
                        price:q.regularMarketPrice,
                        change:q.regularMarketChange,
                        changePct:q.regularMarketChangePercent,
                        prevClose:q.regularMarketPreviousClose,
                        name:q.shortName||q.symbol
                    };
                });
                return prices;
            }
        }catch(e){console.log('Proxy failed:',e.message);continue;}
    }

    // Fallback: fetch individual charts
    try{
        const prices={};
        const chunks=[];
        for(let i=0;i<tickers.length;i+=5)chunks.push(tickers.slice(i,i+5));
        for(const chunk of chunks){
            const promises=chunk.map(async ticker=>{
                for(const proxy of proxies){
                    try{
                        const url=`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=5d`;
                        const res=await fetch(proxy(url),{signal:AbortSignal.timeout(6000)});
                        if(!res.ok)continue;
                        const data=await res.json();
                        const meta=data.chart.result[0].meta;
                        const closes=data.chart.result[0].indicators.quote[0].close.filter(v=>v!==null);
                        const price=meta.regularMarketPrice||closes[closes.length-1];
                        const prevClose=meta.chartPreviousClose||meta.previousClose||closes[closes.length-2]||price;
                        prices[ticker]={price,change:price-prevClose,changePct:(price-prevClose)/prevClose*100,prevClose,name:ticker};
                        return;
                    }catch(e){continue;}
                }
            });
            await Promise.all(promises);
        }
        if(Object.keys(prices).length>0)return prices;
    }catch(e){console.log('Chart fallback failed:',e.message)}

    return null;
}

function applyPrices(prices){
    if(!prices)return;
    priceCache=prices;
    // Update signals
    signals.forEach(sig=>{
        if(prices[sig.s]){
            sig.cp=prices[sig.s].price;
            sig.tp=Math.round(sig.cp*(1+(.05+sig.sc*.15))*100)/100; // target = current * (1 + upside based on score)
            sig._change=prices[sig.s].change;
            sig._changePct=prices[sig.s].changePct;
            sig._prevClose=prices[sig.s].prevClose;
        }
    });
    // Update hidden gems
    hiddenGems.forEach(h=>{
        if(prices[h.s]){
            h.cp=prices[h.s].price;
            h._change=prices[h.s].change;
            h._changePct=prices[h.s].changePct;
        }
    });
    // Update screenerAll
    screenerAll.length=0;
    screenerAll.push(...signals,...hiddenGems.map(h=>({s:h.s,n:h.n,sec:h.sec,sc:h.sc,tp:Math.round(h.cp*1.15*100)/100,cp:h.cp,f:{mom:h.mom,val:0,qual:h.qual,risk:0},r:h.r,_change:h._change,_changePct:h._changePct})));

    // Update portfolio current prices
    const p=portfolio();
    let updated=false;
    p.forEach(stock=>{
        if(prices[stock.symbol]){stock.currentPrice=prices[stock.symbol].price;updated=true;}
    });
    if(updated)save(SK,p);

    // Save to cache
    save(PCK,{prices,timestamp:Date.now()});
}

async function refreshPrices(){
    const icon=document.getElementById('refreshIcon');
    icon.classList.add('fa-spin');
    updateDataStatus('loading');

    // Gather all tickers including portfolio
    const portTickers=portfolio().map(s=>s.symbol).filter(t=>!ALL_TICKERS.includes(t));
    const allTickers=[...ALL_TICKERS,...portTickers];

    const prices=await fetchPricesFromYahoo(allTickers);
    icon.classList.remove('fa-spin');

    if(prices&&Object.keys(prices).length>0){
        applyPrices(prices);isLive=true;lastUpdate=new Date();
        updateDataStatus('live');
        toast('Prices updated! '+Object.keys(prices).length+' stocks','success');
    }else{
        updateDataStatus('error');
        toast('Failed to fetch prices. Using cached data.','error');
    }
    renderAll();
}

async function initPrices(){
    // Try loading from cache first
    const cached=load(PCK);
    if(cached&&cached.prices&&cached.timestamp){
        const age=Date.now()-cached.timestamp;
        applyPrices(cached.prices);
        if(age<15*60*1000){ // cache valid for 15 minutes
            isLive=true;lastUpdate=new Date(cached.timestamp);
            updateDataStatus('cached','Cached '+Math.round(age/60000)+'m ago');
            renderAll();
            return;
        }
    }
    // Fetch fresh prices
    updateDataStatus('loading');
    const portTickers=portfolio().map(s=>s.symbol).filter(t=>!ALL_TICKERS.includes(t));
    const allTickers=[...ALL_TICKERS,...portTickers];
    const prices=await fetchPricesFromYahoo(allTickers);
    if(prices&&Object.keys(prices).length>0){
        applyPrices(prices);isLive=true;lastUpdate=new Date();
        updateDataStatus('live');
    }else if(cached&&cached.prices){
        applyPrices(cached.prices);
        updateDataStatus('cached','Using old cache');
    }else{
        updateDataStatus('error');
    }
    renderAll();
}

// Auto-refresh every 5 minutes during market hours
setInterval(()=>{
    const now=new Date();const h=now.getUTCHours();
    // US market: 14:30-21:00 UTC (9:30-16:00 ET)
    if(h>=14&&h<=21&&now.getUTCDay()>=1&&now.getUTCDay()<=5){refreshPrices();}
},5*60*1000);

// ===== Ticker Search & Prediction =====
const searchHistory=load('qis_search_v1')||[];

async function searchStock(){
    const input=document.getElementById('searchTicker');
    const ticker=input.value.trim().toUpperCase();
    const box=document.getElementById('searchResult');
    if(!ticker){toast('Enter a ticker symbol','error');return}

    box.innerHTML='<div style="text-align:center;padding:1.5rem;color:var(--text3)"><i class="fas fa-spinner fa-spin" style="font-size:1.5rem;color:var(--orange)"></i><p style="margin-top:.5rem">Analyzing '+ticker+'...</p></div>';

    try{
        // Fetch price data + historical for momentum calc
        const proxies=[
            url=>`https://corsproxy.io/?${encodeURIComponent(url)}`,
            url=>`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        ];
        let chartData=null;
        for(const proxy of proxies){
            try{
                const url=`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=6mo`;
                const res=await fetch(proxy(url),{signal:AbortSignal.timeout(10000)});
                if(!res.ok)continue;
                chartData=await res.json();break;
            }catch(e){continue;}
        }
        if(!chartData||!chartData.chart||!chartData.chart.result||!chartData.chart.result[0]){
            box.innerHTML='<div style="text-align:center;padding:1.5rem"><i class="fas fa-exclamation-circle" style="font-size:2rem;color:var(--danger);margin-bottom:.5rem"></i><p style="color:var(--danger);font-weight:600">Ticker "'+ticker+'" not found</p><p style="color:var(--text3);font-size:.8rem">Check the symbol and try again</p></div>';
            return;
        }

        const result=chartData.chart.result[0];
        const meta=result.meta;
        const closes=result.indicators.quote[0].close.filter(v=>v!=null);
        const highs=result.indicators.quote[0].high.filter(v=>v!=null);
        const lows=result.indicators.quote[0].low.filter(v=>v!=null);
        const volumes=result.indicators.quote[0].volume.filter(v=>v!=null);
        const timestamps=result.timestamp||[];

        const price=meta.regularMarketPrice||closes[closes.length-1];
        const prevClose=meta.chartPreviousClose||meta.previousClose||closes[closes.length-2]||price;
        const dailyChg=price-prevClose;
        const dailyPct=(dailyChg/prevClose*100);
        const name=meta.shortName||meta.longName||ticker;
        const currency=meta.currency||'USD';
        const exchange=meta.exchangeName||'';

        // Calculate factors from historical data
        const n=closes.length;
        // Momentum: 6-month return
        const ret6m=n>1?((closes[n-1]/closes[0])-1)*100:0;
        // 1-month return
        const ret1m=n>21?((closes[n-1]/closes[n-22])-1)*100:ret6m/6;
        // Volatility
        const dailyRets=[];for(let i=1;i<closes.length;i++)dailyRets.push((closes[i]-closes[i-1])/closes[i-1]);
        const avgRet=dailyRets.reduce((a,b)=>a+b,0)/dailyRets.length;
        const variance=dailyRets.reduce((a,r)=>a+Math.pow(r-avgRet,2),0)/dailyRets.length;
        const vol=Math.sqrt(variance)*Math.sqrt(252)*100; // annualized vol %

        // Simple MA gap
        const ma50=n>=50?closes.slice(-50).reduce((a,b)=>a+b,0)/50:price;
        const ma200=n>=130?closes.slice(-130).reduce((a,b)=>a+b,0)/130:ma50;
        const maGap=((price-ma50)/ma50*100);

        // 52-week high proximity
        const high52=Math.max(...highs);
        const nearHigh=((price/high52)*100);

        // Volume trend
        const recentVol=volumes.slice(-20).reduce((a,b)=>a+b,0)/Math.min(20,volumes.length);
        const olderVol=volumes.slice(-60,-20).reduce((a,b)=>a+b,0)/Math.min(40,volumes.length)||recentVol;
        const volTrend=((recentVol/olderVol)-1)*100;

        // Factor z-scores (normalized approx)
        const momZ=Math.max(-3,Math.min(3,(ret6m-15)/20));
        const valZ=Math.max(-3,Math.min(3,(20-vol)/15)); // low vol = value proxy
        const qualZ=Math.max(-3,Math.min(3,(maGap)/10));
        const riskZ=Math.max(-3,Math.min(3,(nearHigh-85)/10));

        // AI Score (composite)
        const rawScore=(momZ*0.3+qualZ*0.25+valZ*0.2+riskZ*0.25+1.5)/3;
        const aiScore=Math.max(0.1,Math.min(0.99,rawScore));
        const rating=aiScore>=0.8?'Strong Buy':aiScore>=0.65?'Buy':aiScore>=0.5?'Hold':aiScore>=0.35?'Weak Hold':'Sell';
        const ratingColor=aiScore>=0.8?'var(--success)':aiScore>=0.65?'var(--info)':aiScore>=0.5?'var(--warning)':aiScore>=0.35?'var(--orange)':'var(--danger)';

        // Target price (based on score + momentum)
        const upside=(aiScore-0.3)*30; // -6% to +20%
        const targetPrice=price*(1+upside/100);

        // Mini price chart data
        const chartDates=timestamps.map(t=>new Date(t*1000).toISOString().split('T')[0]);

        // Save to search history
        if(!searchHistory.find(h=>h.s===ticker)){
            searchHistory.unshift({s:ticker,n:name,t:Date.now()});
            if(searchHistory.length>20)searchHistory.pop();
            save('qis_search_v1',searchHistory);
        }

        // Render result
        box.innerHTML=`
        <div style="border:1px solid var(--border);border-radius:12px;overflow:hidden">
            <div style="background:linear-gradient(135deg,rgba(232,121,58,0.08),rgba(167,139,250,0.05));padding:1rem;border-bottom:1px solid var(--border)">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div style="font-size:1.1rem;font-weight:800;color:var(--text)">${ticker} <span style="font-size:.7rem;color:var(--text3);font-weight:400">${exchange}</span></div>
                        <div style="font-size:.8rem;color:var(--text3)">${name} Â· ${currency}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:1.3rem;font-weight:800;color:var(--text)">$${price.toFixed(2)}</div>
                        <div style="font-size:.85rem;font-weight:700;color:${dailyPct>=0?'var(--success)':'var(--danger)'}">${dailyPct>=0?'+':''}${dailyPct.toFixed(2)}% (${dailyChg>=0?'+':''}$${dailyChg.toFixed(2)})</div>
                    </div>
                </div>
            </div>
            <div style="padding:1rem">
                <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.85rem">
                    <div style="font-size:2rem;font-weight:900;color:${ratingColor}">${(aiScore*100).toFixed(0)}</div>
                    <div>
                        <div style="font-size:.9rem;font-weight:700;color:${ratingColor}">${rating}</div>
                        <div style="font-size:.65rem;color:var(--text3)">AI Multi-Factor Score</div>
                    </div>
                    <div style="margin-left:auto;text-align:right">
                        <div style="font-size:.65rem;color:var(--text3)">TARGET</div>
                        <div style="font-size:1rem;font-weight:700;color:var(--success)">$${targetPrice.toFixed(2)} (${upside>=0?'+':''}${upside.toFixed(1)}%)</div>
                    </div>
                </div>
                <div id="searchMiniChart" style="height:150px;margin-bottom:.85rem"></div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.4rem;margin-bottom:.85rem">
                    ${[['MOM',momZ],['VAL',valZ],['QUAL',qualZ],['RISK',riskZ]].map(([k,v])=>
                        `<div style="background:var(--bg);padding:.5rem;border-radius:8px;text-align:center;border:1px solid var(--border)"><div style="font-size:.6rem;color:var(--text3)">${k}</div><div style="font-size:.95rem;font-weight:700;color:${v>0?'var(--success)':'var(--danger)'};">${v.toFixed(2)}</div></div>`
                    ).join('')}
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.4rem;margin-bottom:.85rem">
                    ${[
                        ['6M Return',(ret6m>=0?'+':'')+ret6m.toFixed(1)+'%',ret6m>=0?'var(--success)':'var(--danger)'],
                        ['1M Return',(ret1m>=0?'+':'')+ret1m.toFixed(1)+'%',ret1m>=0?'var(--success)':'var(--danger)'],
                        ['Volatility',vol.toFixed(1)+'%',vol<25?'var(--success)':vol<40?'var(--warning)':'var(--danger)'],
                        ['MA50 Gap',(maGap>=0?'+':'')+maGap.toFixed(1)+'%',maGap>=0?'var(--success)':'var(--danger)'],
                        ['52W High',nearHigh.toFixed(1)+'%',nearHigh>90?'var(--success)':'var(--warning)'],
                        ['Vol Trend',(volTrend>=0?'+':'')+volTrend.toFixed(0)+'%',volTrend>0?'var(--info)':'var(--text3)'],
                    ].map(([l,v,c])=>`<div style="background:var(--bg);padding:.55rem;border-radius:8px;border:1px solid var(--border)"><div style="font-size:.6rem;color:var(--text3)">${l}</div><div style="font-size:.85rem;font-weight:700;color:${c}">${v}</div></div>`).join('')}
                </div>
                <div style="display:flex;gap:.5rem">
                    <button class="btn btn-primary" style="flex:1" onclick="addSearchToPortfolio('${ticker}','${name.replace(/'/g,"\\'")}',${price})"><i class="fas fa-plus"></i> Add to Portfolio</button>
                    <button class="btn btn-ghost" style="flex:1" onclick="addSearchToSignals('${ticker}','${name.replace(/'/g,"\\'")}',${price},${aiScore},${targetPrice},${momZ},${valZ},${qualZ},${riskZ})"><i class="fas fa-bookmark"></i> Watch</button>
                </div>
            </div>
        </div>`;

        // Draw mini chart
        Plotly.newPlot('searchMiniChart',[{
            x:chartDates,y:closes,type:'scatter',mode:'lines',
            line:{color:'#e8793a',width:2},fill:'tozeroy',fillcolor:'rgba(232,121,58,0.06)'
        }],{...plotDark,margin:{t:5,r:5,b:25,l:45},yaxis:{gridcolor:'rgba(42,58,92,.3)'},xaxis:{gridcolor:'rgba(42,58,92,.3)'}},{responsive:true,displayModeBar:false});

    }catch(e){
        box.innerHTML='<div style="text-align:center;padding:1.5rem"><i class="fas fa-wifi" style="font-size:2rem;color:var(--danger);margin-bottom:.5rem"></i><p style="color:var(--danger);font-weight:600">Network error</p><p style="color:var(--text3);font-size:.8rem">'+e.message+'</p></div>';
    }
}

function addSearchToPortfolio(sym,name,price){
    document.getElementById('aSymbol').value=sym;
    document.getElementById('aName').value=name;
    document.getElementById('aCur').value=price.toFixed(2);
    document.getElementById('aBuy').value=price.toFixed(2);
    document.getElementById('aQty').value='';
    document.getElementById('addModal').classList.add('show');
}

function addSearchToSignals(sym,name,price,sc,tp,mom,val,qual,risk){
    // Check if already exists
    if(!signals.find(s=>s.s===sym)){
        signals.push({s:sym,n:name,sec:'Custom',sc,tp,cp:price,f:{mom,val,qual,risk},r:'User-analyzed ticker',_changePct:0});
        screenerAll.push({s:sym,n:name,sec:'Custom',sc,tp,cp:price,f:{mom,val,qual,risk},r:'User-analyzed ticker',_changePct:0});
    }
    toast(sym+' added to watchlist','success');
    renderSigs();
}

// Screener universe (mutable - rebuilt when prices update)
let screenerAll=[...signals,...hiddenGems.map(h=>({s:h.s,n:h.n,sec:h.sec,sc:h.sc,tp:Math.round(h.cp*1.15),cp:h.cp,f:{mom:h.mom,val:0,qual:h.qual,risk:0},r:h.r}))];
const sectors=['Tech','Healthcare','Consumer','Communication','Finance','Energy','Industrial'];

// ===== Storage =====
function load(k){try{return JSON.parse(localStorage.getItem(k))||null}catch{return null}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function portfolio(){return load(SK)||[]}
function trades(){return load(TLK)||[]}
function settings(){return load(STK)||{currency:'USD',model:'lgbm',horizon:'1y'}}
function saveSetting(k,v){const s=settings();s[k]=v;save(STK,s);toast('Saved','success');renderAll()}
function updateWeight(el){document.getElementById(el.id+'Val').textContent=parseFloat(el.value).toFixed(2)}

// ===== Helpers =====
function fmt(n){const s=settings();return s.currency==='KRW'?new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(n):new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2}).format(n)}
function pct(n){return(n>=0?'+':'')+n.toFixed(2)+'%'}
function pc(v){return v>=0?'pnl-pos':'pnl-neg'}

// ===== Toast =====
function toast(m,t=''){const e=document.getElementById('toast');e.textContent=m;e.className='toast '+t;setTimeout(()=>e.classList.add('show'),10);setTimeout(()=>e.classList.remove('show'),2500)}

// ===== Navigation =====
function go(p,btn){
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab-item').forEach(x=>x.classList.remove('active'));
    document.getElementById('page-'+p).classList.add('active');
    if(btn)btn.classList.add('active');
    renderAll();window.scrollTo({top:0,behavior:'smooth'});
}

// ===== Modals =====
function closeModals(){document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('show'))}
document.querySelectorAll('.modal-overlay').forEach(o=>{o.addEventListener('click',function(e){if(e.target===this)closeModals()})});

// ===== CRUD =====
function openAddModal(pf){
    closeModals();
    if(pf){document.getElementById('aSymbol').value=pf.s||'';document.getElementById('aName').value=pf.n||'';document.getElementById('aCur').value=pf.cp||'';document.getElementById('aBuy').value=pf.cp||'';document.getElementById('aQty').value='';document.getElementById('aSector').value=pf.sec||'Tech'}
    else document.querySelectorAll('#addModal input').forEach(i=>i.value='');
    document.getElementById('addModal').classList.add('show');
}
function addStock(){
    const sym=document.getElementById('aSymbol').value.trim().toUpperCase(),name=document.getElementById('aName').value.trim();
    const bp=parseFloat(document.getElementById('aBuy').value),qty=parseInt(document.getElementById('aQty').value);
    const cp=parseFloat(document.getElementById('aCur').value),sec=document.getElementById('aSector').value;
    if(!sym||!bp||!qty||!cp){toast('Fill all fields','error');return}
    const p=portfolio();p.push({symbol:sym,name:name||sym,buyPrice:bp,quantity:qty,currentPrice:cp,sector:sec,date:new Date().toISOString()});
    save(SK,p);logTrade(sym,'BUY',bp,qty);closeModals();toast(sym+' added!','success');renderAll();
}
function openEditModal(i){closeModals();const s=portfolio()[i];document.getElementById('eIdx').value=i;document.getElementById('eCur').value=s.currentPrice;document.getElementById('eQty').value=s.quantity;document.getElementById('editModal').classList.add('show')}
function updateStock(){const i=+document.getElementById('eIdx').value,p=portfolio();p[i].currentPrice=parseFloat(document.getElementById('eCur').value);p[i].quantity=parseInt(document.getElementById('eQty').value);save(SK,p);closeModals();toast('Updated','success');renderAll()}
function sellStock(){const i=+document.getElementById('eIdx').value,p=portfolio(),sym=p[i].symbol;if(confirm('Sell '+sym+'?')){logTrade(sym,'SELL',p[i].currentPrice,p[i].quantity);p.splice(i,1);save(SK,p);closeModals();toast(sym+' sold','success');renderAll()}}
function logTrade(sym,action,price,qty){const t=trades();t.push({symbol:sym,action,price,qty,date:new Date().toISOString()});save(TLK,t)}

// ===== Signal Detail =====
function showSig(sig){
    closeModals();const up=sig.cp?((sig.tp-sig.cp)/sig.cp*100).toFixed(1):'â€”';
    const dailyChg=sig._changePct!=null?sig._changePct:0;
    const dailyStr=(dailyChg>=0?'+':'')+dailyChg.toFixed(2)+'%';
    const dailyColor=dailyChg>=0?'var(--success)':'var(--danger)';
    document.getElementById('sigTitle').innerHTML='<span style="color:var(--orange)">'+sig.s+'</span> '+sig.n;
    document.getElementById('sigContent').innerHTML=
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin:.75rem 0">'+
        [['AI SCORE',(sig.sc*100).toFixed(0)+'/100','var(--orange)'],['TODAY',dailyStr,dailyColor],['CURRENT',sig.cp?fmt(sig.cp):'â€”','var(--text)'],['TARGET',sig.tp?fmt(sig.tp):'â€”','var(--success)'],['UPSIDE','+'+up+'%','var(--success)'],['PREV CLOSE',sig._prevClose?fmt(sig._prevClose):'â€”','var(--text3)']]
        .map(x=>'<div style="background:var(--bg);padding:.7rem;border-radius:10px;border:1px solid var(--border)"><div style="font-size:.65rem;color:var(--text3)">'+x[0]+'</div><div style="font-size:1.15rem;font-weight:800;color:'+x[2]+'">'+x[1]+'</div></div>').join('')+
        '</div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.4rem;margin-bottom:.6rem">'+
        Object.entries(sig.f).map(([k,v])=>'<div style="background:var(--bg);padding:.5rem;border-radius:8px;text-align:center;border:1px solid var(--border)"><div style="font-size:.6rem;color:var(--text3);text-transform:uppercase">'+k+'</div><div style="font-size:.95rem;font-weight:700;color:'+(v>0?'var(--success)':'var(--danger)')+'">'+v.toFixed(1)+'</div></div>').join('')+
        '</div><div style="background:var(--bg);padding:.7rem;border-radius:10px;font-size:.8rem;color:var(--text2);border:1px solid var(--border)"><strong style="color:var(--orange)">Analysis:</strong> '+sig.r+'</div>';
    document.getElementById('sigAddBtn').onclick=()=>{closeModals();openAddModal(sig)};
    document.getElementById('sigModal').classList.add('show');
}

// ===== Regime =====
function getRegime(){const p=portfolio();if(p.length===0)return'WARMUP';const avg=p.reduce((a,s)=>(s.currentPrice-s.buyPrice)/s.buyPrice*100+a,0)/p.length;return avg>5?'NORMAL':avg>-5?'WARNING':'BREAKDOWN'}
function regimeHTML(r){const m={'NORMAL':['var(--success)','regime-normal'],'WARNING':['var(--warning)','regime-warning'],'BREAKDOWN':['var(--danger)','regime-breakdown'],'WARMUP':['var(--text3)','regime-normal']};const[c,cls]=m[r]||m.WARMUP;return'<span class="regime '+cls+'">'+r+'</span>'}

// ===== RENDER ALL =====
function renderAll(){renderDash();renderPort();renderSigs();renderScreener();renderAnalysis();renderTradeLog();
    const s=settings();['setCurrency','setModel','setHorizon'].forEach(id=>{const el=document.getElementById(id);if(el&&s[id.replace('set','').toLowerCase()])el.value=s[id.replace('set','').toLowerCase()]});}

function renderDash(){
    const p=portfolio();let inv=0,cur=0;p.forEach(s=>{inv+=s.buyPrice*s.quantity;cur+=s.currentPrice*s.quantity});
    const pnl=cur-inv,ret=inv>0?pnl/inv*100:0,regime=getRegime();
    document.getElementById('dashSummary').innerHTML=
        [{l:'Total P&L',v:fmt(pnl),c:pc(pnl),b:'orange'},{l:'Return',v:pct(ret),c:pc(ret),b:'green'},{l:'Invested',v:fmt(inv),c:'',b:'blue'},{l:'Value',v:fmt(cur),c:'',b:'purple'},{l:'Regime',v:regimeHTML(regime),c:'',b:'cyan'}]
        .map(x=>'<div class="summary-item '+x.b+'"><div class="summary-label">'+x.l+'</div><div class="summary-value '+x.c+'">'+x.v+'</div></div>').join('');

    // Perf chart
    if(p.length===0){Plotly.newPlot('perfChart',[],{...plotDark,annotations:[{text:'Add stocks to begin',showarrow:false,font:{size:13,color:'#5a5050'}}],xaxis:{visible:false},yaxis:{visible:false}},{responsive:true,displayModeBar:false});
        Plotly.newPlot('ddChart',[],{...plotDark,annotations:[{text:'No data',showarrow:false,font:{size:12,color:'#5a5050'}}],xaxis:{visible:false},yaxis:{visible:false}},{responsive:true,displayModeBar:false});
        Plotly.newPlot('monthlyChart',[],{...plotDark,xaxis:{visible:false},yaxis:{visible:false}},{responsive:true,displayModeBar:false});
        Plotly.newPlot('sectorChart',[],{...plotDark,xaxis:{visible:false},yaxis:{visible:false}},{responsive:true,displayModeBar:false});
        document.getElementById('topMovers').innerHTML='<div class="empty-state"><i class="fas fa-inbox"></i><p>No stocks</p></div>';return;}

    const days=90,dates=[],vals=[],ddVals=[];let base=inv;
    for(let i=0;i<days;i++){const d=new Date();d.setDate(d.getDate()-(days-i));dates.push(d.toISOString().split('T')[0]);base*=(1+(Math.random()-.47)*.015);vals.push(base)}
    vals[vals.length-1]=cur;
    let peak=vals[0];ddVals.push(0);for(let i=1;i<vals.length;i++){peak=Math.max(peak,vals[i]);ddVals.push((vals[i]-peak)/peak*100)}

    Plotly.newPlot('perfChart',[{x:dates,y:vals,type:'scatter',mode:'lines',line:{color:'#e8793a',width:2},fill:'tozeroy',fillcolor:'rgba(232,121,58,0.06)'}],{...plotDark,yaxis:{gridcolor:'rgba(42,58,92,.3)',tickformat:',.0f'},xaxis:{gridcolor:'rgba(42,58,92,.3)'}},{responsive:true,displayModeBar:false});

    Plotly.newPlot('ddChart',[{x:dates,y:ddVals,type:'scatter',mode:'lines',fill:'tozeroy',line:{color:'#ff6b6b',width:1.5},fillcolor:'rgba(255,107,107,0.06)'}],{...plotDark,margin:{t:5,r:10,b:25,l:40},yaxis:{gridcolor:'rgba(42,58,92,.3)',title:'DD%'},xaxis:{gridcolor:'rgba(42,58,92,.3)'}},{responsive:true,displayModeBar:false});

    // Monthly
    const months=[],mRets=[];for(let i=5;i>=0;i--){const d=new Date();d.setMonth(d.getMonth()-i);months.push(d.toLocaleDateString('en',{month:'short',year:'2-digit'}));mRets.push((Math.random()-.42)*8)}
    Plotly.newPlot('monthlyChart',[{x:months,y:mRets,type:'bar',marker:{color:mRets.map(r=>r>=0?'#2dd4a8':'#ff6b6b')},text:mRets.map(r=>(r>=0?'+':'')+r.toFixed(1)+'%'),textposition:'outside',textfont:{size:10,color:'#7a6f63'}}],{...plotDark,yaxis:{gridcolor:'rgba(42,58,92,.3)',title:'%'},xaxis:{gridcolor:'rgba(42,58,92,.3)'}},{responsive:true,displayModeBar:false});

    // Sector
    const secMap={};p.forEach(s=>{secMap[s.sector]=(secMap[s.sector]||0)+s.currentPrice*s.quantity});
    Plotly.newPlot('sectorChart',[{values:Object.values(secMap),labels:Object.keys(secMap),type:'pie',hole:.55,marker:{colors:['#e8793a','#f4a261','#a78bfa','#4fc3f7','#2dd4a8','#ff6b6b','#ffd166']},textinfo:'label+percent',textfont:{size:10,color:'#b8a99a'}}],{...plotDark,margin:{t:5,r:5,b:5,l:5},showlegend:false},{responsive:true,displayModeBar:false});

    // Top movers
    const sorted=[...p].map((s,i)=>({...s,idx:i,ret:(s.currentPrice-s.buyPrice)/s.buyPrice*100})).sort((a,b)=>b.ret-a.ret);
    document.getElementById('topMovers').innerHTML=sorted.slice(0,5).map(s=>
        '<div class="stock-item" onclick="openEditModal('+s.idx+')"><div class="stock-left"><div class="stock-icon">'+s.symbol.slice(0,3)+'</div><div><div class="stock-name">'+s.symbol+'</div><div class="stock-sub">'+s.name+'</div></div></div><div class="stock-right"><div class="stock-price">'+fmt(s.currentPrice)+'</div><div class="stock-change '+(s.ret>=0?'up':'down')+'">'+pct(s.ret)+'</div></div></div>'
    ).join('');
}

function renderPort(){
    const p=portfolio(),c=document.getElementById('portfolioList');
    if(!p.length){c.innerHTML='<div class="empty-state"><i class="fas fa-wallet"></i><p>No stocks yet</p><p style="font-size:.75rem;margin-top:.3rem">Add from Signals or use + button</p></div>';return}
    c.innerHTML=p.map((s,i)=>{const pnl=(s.currentPrice-s.buyPrice)*s.quantity,ret=(s.currentPrice-s.buyPrice)/s.buyPrice*100;
        return'<div class="portfolio-item" onclick="openEditModal('+i+')"><div class="portfolio-top"><div class="stock-left"><div class="stock-icon">'+s.symbol.slice(0,3)+'</div><div><div class="stock-name">'+s.symbol+'</div><div class="stock-sub">'+s.name+'</div></div></div><div class="stock-right"><div class="stock-price '+pc(pnl)+'">'+fmt(pnl)+'</div><div class="stock-change '+(ret>=0?'up':'down')+'">'+pct(ret)+'</div></div></div><div class="portfolio-details"><div><div class="detail-label">Buy</div><div class="detail-value">'+fmt(s.buyPrice)+'</div></div><div><div class="detail-label">Current</div><div class="detail-value">'+fmt(s.currentPrice)+'</div></div><div><div class="detail-label">Qty</div><div class="detail-value">'+s.quantity+'</div></div></div></div>'}).join('');
}

function renderSigs(){
    document.getElementById('signalsList').innerHTML=signals.map(sig=>{
        const chg=sig._changePct!=null?sig._changePct:((sig.tp-sig.cp)/sig.cp*100);
        const chgDir=chg>=0?'up':'down';
        const bc=sig.sc>=.9?'badge-strong':sig.sc>=.8?'badge-buy':'badge-hold';
        const bt=sig.sc>=.9?'Strong Buy':sig.sc>=.8?'Buy':'Hold';
        return'<div class="stock-item" onclick=\'showSig('+JSON.stringify(sig).replace(/'/g,"\\'")+')\'><div class="stock-left"><div class="stock-icon">'+sig.s.slice(0,3)+'</div><div><div class="stock-name">'+sig.s+' <span class="badge '+bc+'">'+bt+'</span></div><div class="stock-sub">'+sig.n+'</div></div></div><div class="stock-right"><div class="stock-price">'+(sig.cp?fmt(sig.cp):'â€”')+'</div><div class="stock-change '+chgDir+'">'+(chg>=0?'+':'')+chg.toFixed(2)+'%</div></div></div>'}).join('');

    // Factor heatmap
    const tickers=signals.slice(0,8).map(s=>s.s),factors=['Momentum','Value','Quality','Risk'];
    const z=signals.slice(0,8).map(s=>[s.f.mom,s.f.val,s.f.qual,s.f.risk]);
    Plotly.newPlot('heatmapChart',[{z,x:factors,y:tickers,type:'heatmap',colorscale:[[0,'#ff6b6b'],[.5,'#1a1a2e'],[1,'#2dd4a8']],zmid:0,text:z.map(r=>r.map(v=>v.toFixed(1))),texttemplate:'%{text}',textfont:{size:10},colorbar:{title:'Z',tickfont:{color:'#7a6f63'},titlefont:{color:'#7a6f63'}}}],{...plotDark,margin:{t:5,r:10,b:30,l:55},xaxis:{side:'top'}},{responsive:true,displayModeBar:false});

    // Factor bar
    Plotly.newPlot('factorChart',[{x:[8.5,7.2,6.8,5.5,4.1],y:['Momentum','Quality','Growth','Value','Low Vol'],type:'bar',orientation:'h',marker:{color:['#e8793a','#f4a261','#a78bfa','#2dd4a8','#4fc3f7']},text:['8.5','7.2','6.8','5.5','4.1'],textposition:'outside',textfont:{color:'#7a6f63'}}],{...plotDark,margin:{t:5,r:35,b:25,l:75},xaxis:{gridcolor:'rgba(42,58,92,.3)'}},{responsive:true,displayModeBar:false});
}

function renderScreener(){
    const fEl=document.getElementById('screenerFilters');
    fEl.innerHTML=['All',...sectors].map(s=>'<span class="filter-chip'+(s==='All'?' active':'')+'" onclick="filterScreener(this,\''+s+'\')">'+s+'</span>').join('');
    filterScreener(null,'All');

    document.getElementById('hiddenChampions').innerHTML=hiddenGems.map(h=>{
        const chg=h._changePct!=null?h._changePct:0;const chgDir=chg>=0?'up':'down';
        return'<div class="stock-item"><div class="stock-left"><div class="stock-icon" style="background:linear-gradient(135deg,var(--purple),#7c3aed)">'+h.s.slice(0,3)+'</div><div><div class="stock-name">'+h.s+' <span class="badge badge-strong" style="background:rgba(167,139,250,0.12);color:var(--purple);border-color:rgba(167,139,250,0.25)">'+h.sc.toFixed(2)+'</span></div><div class="stock-sub">'+h.n+' Â· '+h.sec+'</div></div></div><div class="stock-right"><div class="stock-price">'+(h.cp?fmt(h.cp):'â€”')+'</div><div class="stock-change '+chgDir+'">'+(chg>=0?'+':'')+chg.toFixed(2)+'%</div></div></div>'}).join('');
}
function filterScreener(el,sec){
    if(el){document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active')}
    const filtered=sec==='All'?screenerAll:screenerAll.filter(s=>s.sec===sec);
    document.getElementById('screenerResults').innerHTML=filtered.sort((a,b)=>b.sc-a.sc).map(s=>{
        const chg=s._changePct!=null?s._changePct:((s.tp-s.cp)/s.cp*100);
        const chgDir=chg>=0?'up':'down';
        return'<div class="stock-item" onclick=\'showSig('+JSON.stringify(s).replace(/'/g,"\\'")+')\'><div class="stock-left"><div class="stock-icon">'+s.s.slice(0,3)+'</div><div><div class="stock-name">'+s.s+' <span class="badge badge-buy">'+(s.sc*100).toFixed(0)+'</span></div><div class="stock-sub">'+s.n+' Â· '+s.sec+'</div></div></div><div class="stock-right"><div class="stock-price">'+(s.cp?fmt(s.cp):'â€”')+'</div><div class="stock-change '+chgDir+'">'+(chg>=0?'+':'')+chg.toFixed(2)+'%</div></div></div>'}).join('');
}

function renderAnalysis(){
    const p=portfolio();
    if(!p.length){['analysisChart','shapChart','scenarioChart'].forEach(id=>Plotly.newPlot(id,[],{...plotDark,annotations:[{text:'Add stocks',showarrow:false,font:{size:13,color:'#5a5050'}}],xaxis:{visible:false},yaxis:{visible:false}},{responsive:true,displayModeBar:false}));
        document.getElementById('riskMetrics').innerHTML='<div class="empty-state"><i class="fas fa-chart-line"></i><p>No data</p></div>';
        document.getElementById('scenarioSelector').innerHTML='';document.getElementById('scenarioSummary').innerHTML='';return;}

    const rets=p.map(s=>(s.currentPrice-s.buyPrice)/s.buyPrice*100);
    Plotly.newPlot('analysisChart',[{x:p.map(s=>s.symbol),y:rets,type:'bar',marker:{color:rets.map(r=>r>=0?'#2dd4a8':'#ff6b6b')},text:rets.map(r=>pct(r)),textposition:'outside',textfont:{size:10,color:'#7a6f63'}}],{...plotDark,yaxis:{gridcolor:'rgba(42,58,92,.3)',title:'Return %'},xaxis:{gridcolor:'rgba(42,58,92,.3)'}},{responsive:true,displayModeBar:false});

    const avg=rets.reduce((a,b)=>a+b,0)/rets.length,best=Math.max(...rets),worst=Math.min(...rets);
    const wr=(rets.filter(r=>r>=0).length/rets.length*100).toFixed(0);
    const tv=p.reduce((s,x)=>s+x.currentPrice*x.quantity,0),mp=Math.max(...p.map(x=>x.currentPrice*x.quantity));
    document.getElementById('riskMetrics').innerHTML=
        [{l:'AVG RETURN',v:pct(avg),c:pc(avg)},{l:'WIN RATE',v:wr+'%',c:'color:var(--orange)'},{l:'BEST',v:pct(best),c:'color:var(--success)'},{l:'WORST',v:pct(worst),c:'color:var(--danger)'},{l:'POSITIONS',v:p.length,c:''},{l:'CONCENTRATION',v:(mp/tv*100).toFixed(1)+'%',c:''}]
        .map(x=>'<div style="background:var(--bg);padding:.7rem;border-radius:10px;border:1px solid var(--border)"><div style="font-size:.65rem;color:var(--text3)">'+x.l+'</div><div style="font-size:1.1rem;font-weight:800;'+x.c+'">'+x.v+'</div></div>')
        .join('').replace(/^/,'<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.6rem">')+'</div>';

    // SHAP
    const feats=['ret_12m','vol_3m','trailingPE','ROE','ret_1m','ma_gap','profitMargin','momentum','down_vol','P/B'];
    const imps=feats.map(()=>Math.random()*.15+.02).sort((a,b)=>b-a);
    Plotly.newPlot('shapChart',[{y:feats.slice().reverse(),x:imps.slice().reverse(),type:'bar',orientation:'h',marker:{color:imps.slice().reverse().map(()=>Math.random()>.5?'#2dd4a8':'#ff6b6b')},text:imps.slice().reverse().map(v=>v.toFixed(3)),textposition:'outside',textfont:{color:'#7a6f63',size:10}}],{...plotDark,margin:{t:5,r:40,b:25,l:85},xaxis:{gridcolor:'rgba(42,58,92,.3)',title:'SHAP Value'}},{responsive:true,displayModeBar:false});

    // Scenario
    const first=p[0];
    document.getElementById('scenarioSelector').innerHTML='<div style="font-size:.8rem;color:var(--text2)">Simulating: <strong style="color:var(--orange)">'+first.symbol+'</strong></div>';
    const cp=first.currentPrice,drift=.0003,vol=.02,d2=120;
    const base=[cp],opt=[cp],pess=[cp];
    for(let i=1;i<=d2;i++){base.push(base[i-1]*Math.exp(drift));opt.push(opt[i-1]*Math.exp(drift+vol));pess.push(pess[i-1]*Math.exp(drift-vol))}
    const xd=Array.from({length:d2+1},(_,i)=>i);
    Plotly.newPlot('scenarioChart',[
        {x:xd,y:opt,name:'Optimistic',line:{color:'#2dd4a8',width:2,dash:'dash'}},
        {x:xd,y:base,name:'Base',line:{color:'#e8793a',width:2.5}},
        {x:xd,y:pess,name:'Pessimistic',line:{color:'#ff6b6b',width:2,dash:'dash'}},
    ],{...plotDark,legend:{orientation:'h',y:1.08,font:{color:'#7a6f63'}},yaxis:{gridcolor:'rgba(42,58,92,.3)',title:'Price'},xaxis:{gridcolor:'rgba(42,58,92,.3)',title:'Days'}},{responsive:true,displayModeBar:false});
    document.getElementById('scenarioSummary').innerHTML='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem">'+
        [{l:'Base',v:fmt(base[d2]),c:'var(--orange)'},{l:'Optimistic',v:fmt(opt[d2]),c:'var(--success)'},{l:'Pessimistic',v:fmt(pess[d2]),c:'var(--danger)'}]
        .map(x=>'<div style="background:var(--bg);padding:.6rem;border-radius:8px;text-align:center;border:1px solid var(--border)"><div style="font-size:.65rem;color:var(--text3)">'+x.l+'</div><div style="font-size:1rem;font-weight:800;color:'+x.c+'">'+x.v+'</div></div>').join('')+'</div>';
}

function renderTradeLog(){
    const t=trades(),c=document.getElementById('tradeLog');
    if(!t.length){c.innerHTML='<div class="empty-state"><i class="fas fa-history"></i><p>No trades yet</p></div>';
    }else{c.innerHTML=t.slice().reverse().slice(0,20).map(tr=>
        '<div class="trade-row"><div><span style="font-weight:700;color:var(--text)">'+tr.symbol+'</span> <span class="badge '+(tr.action==='BUY'?'badge-buy':'badge-hold')+'" style="'+(tr.action==='SELL'?'background:rgba(255,107,107,.12);color:var(--danger);border:1px solid rgba(255,107,107,.25)':'')+'">'+tr.action+'</span></div><div style="text-align:right"><div style="font-weight:600">'+fmt(tr.price)+' x '+tr.qty+'</div><div style="font-size:.7rem;color:var(--text3)">'+new Date(tr.date).toLocaleDateString()+'</div></div></div>'
    ).join('')}

    // Prediction tracking
    const p=portfolio();
    document.getElementById('predTracking').innerHTML=p.length?
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem">'+
        [{l:'Predictions',v:signals.length},{l:'Portfolio',v:p.length},{l:'Tracked',v:t.length},{l:'Model',v:settings().model.toUpperCase()}]
        .map(x=>'<div style="background:var(--bg);padding:.6rem;border-radius:8px;border:1px solid var(--border)"><div style="font-size:.65rem;color:var(--text3)">'+x.l+'</div><div style="font-size:1rem;font-weight:700;color:var(--orange)">'+x.v+'</div></div>').join('')+'</div>':
        '<p style="font-size:.8rem;color:var(--text3)">Run strategy and add stocks to track predictions.</p>';

    // Accuracy chart
    if(t.length>=2){const dates=[],acc=[];let correct=0;
        t.forEach((tr,i)=>{if(tr.action==='SELL')correct++;acc.push(t.length>0?(correct/(i+1)*100):50);dates.push(new Date(tr.date).toLocaleDateString())});
        Plotly.newPlot('accuracyChart',[{x:dates,y:acc,type:'scatter',mode:'lines+markers',line:{color:'#e8793a',width:2},marker:{size:5,color:'#f4a261'}}],{...plotDark,yaxis:{gridcolor:'rgba(42,58,92,.3)',title:'Accuracy %'},xaxis:{gridcolor:'rgba(42,58,92,.3)'}},{responsive:true,displayModeBar:false});
    }else{Plotly.newPlot('accuracyChart',[],{...plotDark,annotations:[{text:'More trades needed',showarrow:false,font:{size:12,color:'#5a5050'}}],xaxis:{visible:false},yaxis:{visible:false}},{responsive:true,displayModeBar:false})}
}

// ===== Export =====
function exportData(){const p=portfolio();if(!p.length){toast('No data','error');return}
    const csv=['Symbol,Name,Buy,Current,Qty,P&L,Return%,Sector'];p.forEach(s=>{const pnl=(s.currentPrice-s.buyPrice)*s.quantity;csv.push([s.symbol,s.name,s.buyPrice,s.currentPrice,s.quantity,pnl.toFixed(2),((s.currentPrice-s.buyPrice)/s.buyPrice*100).toFixed(2)+'%',s.sector].join(','))});
    const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv.join('\n')],{type:'text/csv'}));a.download='portfolio_'+new Date().toISOString().split('T')[0]+'.csv';a.click();toast('Exported!','success')}

// ===== Run Strategy =====
function runStrategy(){closeModals();const m=document.getElementById('stratModal');m.classList.add('show');
    const f=document.getElementById('progFill'),t=document.getElementById('progText'),l=document.getElementById('stratLog');f.style.width='0%';l.innerHTML='';
    [{p:10,m:'Loading market data...'},{p:25,m:'Computing factor scores...'},{p:40,m:'Running '+settings().model.toUpperCase()+' model...'},{p:55,m:'Generating alpha signals...'},{p:70,m:'Portfolio optimization...'},{p:85,m:'Regime detection...'},{p:95,m:'Risk analysis...'},{p:100,m:'Complete! Signals updated.'}]
    .forEach((s,i)=>{setTimeout(()=>{f.style.width=s.p+'%';t.textContent=s.m;l.innerHTML+='<div>'+new Date().toLocaleTimeString()+' '+s.m+'</div>';l.scrollTop=l.scrollHeight;if(i===7)setTimeout(()=>toast('Strategy complete!','success'),400)},500*(i+1))})}

function resetData(){if(confirm('Delete all data?')){localStorage.removeItem(SK);localStorage.removeItem(TLK);localStorage.removeItem(PCK);toast('Cleared','success');renderAll()}}

// Initial load: fetch real prices then render
initPrices();
</script>
</body>
</html>
