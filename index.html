<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Quant Investment System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #8b5cf6;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-300: #d1d5db; --gray-600: #4b5563; --gray-700: #374151;
            --gray-800: #1f2937; --gray-900: #111827;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh; color:var(--gray-800);
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        /* ===== Layout ===== */
        .app { max-width:1200px; margin:0 auto; padding:1rem; padding-bottom:5rem; }
        .page { display:none; animation: fadeIn 0.3s ease; }
        .page.active { display:block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* ===== Header ===== */
        .header {
            background:rgba(255,255,255,0.1); backdrop-filter:blur(20px);
            padding:1rem 1.25rem; border-radius:16px; margin-bottom:1rem;
            border:1px solid rgba(255,255,255,0.2); display:flex;
            justify-content:space-between; align-items:center;
        }
        .header h1 { color:white; font-size:1.2rem; font-weight:700; }
        .header p { color:rgba(255,255,255,0.8); font-size:0.75rem; }
        .header-right { display:flex; gap:0.5rem; }

        /* ===== Bottom Tab Bar ===== */
        .tab-bar {
            position:fixed; bottom:0; left:0; right:0;
            background:rgba(255,255,255,0.98); backdrop-filter:blur(20px);
            display:flex; justify-content:space-around; align-items:center;
            padding:0.5rem 0; padding-bottom:calc(0.5rem + env(safe-area-inset-bottom, 0));
            border-top:1px solid var(--gray-200); z-index:1000;
            box-shadow:0 -4px 20px rgba(0,0,0,0.08);
        }
        .tab-item {
            display:flex; flex-direction:column; align-items:center; gap:0.2rem;
            padding:0.4rem 0.8rem; border-radius:10px; cursor:pointer;
            transition:all 0.2s; -webkit-tap-highlight-color:transparent;
            touch-action:manipulation; border:none; background:none;
            color:var(--gray-600); font-size:0.65rem; font-weight:600;
        }
        .tab-item i { font-size:1.2rem; }
        .tab-item.active { color:var(--primary); }
        .tab-item.active i { transform:scale(1.1); }

        /* ===== Cards ===== */
        .card {
            background:rgba(255,255,255,0.95); border-radius:16px;
            padding:1.25rem; margin-bottom:1rem;
            box-shadow:0 4px 20px rgba(0,0,0,0.08);
            border:1px solid rgba(255,255,255,0.3);
        }
        .card-title {
            font-size:1rem; font-weight:700; color:var(--gray-900);
            margin-bottom:0.75rem; display:flex; align-items:center; gap:0.5rem;
        }
        .card-title i { color:var(--primary); }

        /* ===== Summary Stats ===== */
        .summary-grid { display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; margin-bottom:1rem; }
        .summary-item {
            background:rgba(255,255,255,0.95); border-radius:14px; padding:1rem;
            box-shadow:0 2px 12px rgba(0,0,0,0.06); position:relative; overflow:hidden;
        }
        .summary-item::before {
            content:''; position:absolute; top:0; left:0; width:3px; height:100%;
        }
        .summary-item.green::before { background:var(--success); }
        .summary-item.red::before { background:var(--danger); }
        .summary-item.blue::before { background:var(--info); }
        .summary-item.purple::before { background:var(--primary); }
        .summary-label { font-size:0.7rem; color:var(--gray-600); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; }
        .summary-value { font-size:1.4rem; font-weight:800; margin-top:0.25rem; }

        /* ===== Stock List Items ===== */
        .stock-item {
            display:flex; justify-content:space-between; align-items:center;
            padding:0.9rem 0; border-bottom:1px solid var(--gray-100);
            cursor:pointer; -webkit-tap-highlight-color:transparent;
        }
        .stock-item:last-child { border-bottom:none; }
        .stock-left { display:flex; align-items:center; gap:0.75rem; }
        .stock-symbol {
            width:42px; height:42px; border-radius:12px; display:flex;
            align-items:center; justify-content:center; font-weight:800;
            font-size:0.7rem; color:white;
            background:linear-gradient(135deg,var(--primary),var(--secondary));
        }
        .stock-name { font-weight:600; font-size:0.9rem; color:var(--gray-900); }
        .stock-sub { font-size:0.75rem; color:var(--gray-600); margin-top:0.1rem; }
        .stock-right { text-align:right; }
        .stock-price { font-weight:700; font-size:0.95rem; }
        .stock-change { font-size:0.8rem; font-weight:600; }
        .stock-change.up { color:var(--danger); }
        .stock-change.down { color:var(--info); }

        /* ===== Buttons ===== */
        .btn {
            padding:0.6rem 1.2rem; border-radius:10px; border:none; font-weight:600;
            cursor:pointer; font-size:0.85rem; display:inline-flex; align-items:center;
            gap:0.4rem; transition:all 0.2s; -webkit-tap-highlight-color:transparent;
            touch-action:manipulation;
        }
        .btn-sm { padding:0.4rem 0.8rem; font-size:0.75rem; border-radius:8px; }
        .btn-primary { background:var(--primary); color:white; }
        .btn-success { background:var(--success); color:white; }
        .btn-danger { background:var(--danger); color:white; }
        .btn-outline {
            background:transparent; border:1.5px solid var(--gray-300); color:var(--gray-700);
        }
        .btn-ghost { background:rgba(255,255,255,0.2); color:white; border:1px solid rgba(255,255,255,0.3); }

        /* ===== Badge ===== */
        .badge {
            display:inline-block; padding:0.2rem 0.6rem; border-radius:20px;
            font-size:0.7rem; font-weight:700;
        }
        .badge-buy { background:#dbeafe; color:#1e40af; }
        .badge-sell { background:#fee2e2; color:#991b1b; }
        .badge-hold { background:#fef3c7; color:#92400e; }
        .badge-strong { background:#d1fae5; color:#065f46; }

        /* ===== P&L Display ===== */
        .pnl-positive { color:var(--danger); }
        .pnl-negative { color:var(--info); }

        /* ===== Portfolio Row ===== */
        .portfolio-item {
            padding:1rem 0; border-bottom:1px solid var(--gray-100);
        }
        .portfolio-item:last-child { border-bottom:none; }
        .portfolio-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; }
        .portfolio-details {
            display:grid; grid-template-columns:repeat(3,1fr); gap:0.5rem;
            background:var(--gray-50); padding:0.6rem; border-radius:8px; font-size:0.75rem;
        }
        .portfolio-detail-label { color:var(--gray-600); }
        .portfolio-detail-value { font-weight:700; margin-top:0.1rem; }
        .portfolio-actions { display:flex; gap:0.5rem; margin-top:0.5rem; }

        /* ===== Toast ===== */
        .toast {
            position:fixed; bottom:5rem; left:50%; transform:translateX(-50%) translateY(100px);
            background:var(--gray-900); color:white; padding:0.8rem 1.2rem;
            border-radius:12px; font-size:0.85rem; font-weight:500; z-index:9999;
            opacity:0; transition:all 0.4s; box-shadow:0 10px 40px rgba(0,0,0,0.3);
            max-width:90vw; text-align:center;
        }
        .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
        .toast.success { background:linear-gradient(135deg,#10b981,#059669); }
        .toast.error { background:linear-gradient(135deg,#ef4444,#dc2626); }

        /* ===== Modal ===== */
        .modal-overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.5);
            backdrop-filter:blur(5px); z-index:9000; display:flex;
            align-items:flex-end; justify-content:center;
            opacity:0; pointer-events:none; transition:opacity 0.3s;
        }
        .modal-overlay.show { opacity:1; pointer-events:auto; }
        .modal {
            background:white; border-radius:20px 20px 0 0; padding:1.5rem;
            width:100%; max-width:500px; max-height:85vh; overflow-y:auto;
            transform:translateY(100%); transition:transform 0.3s;
        }
        .modal-overlay.show .modal { transform:translateY(0); }
        .modal-handle {
            width:40px; height:4px; background:var(--gray-300); border-radius:2px;
            margin:0 auto 1rem; display:block;
        }
        .modal h3 { font-size:1.1rem; margin-bottom:1rem; }
        .form-group { margin-bottom:1rem; }
        .form-group label { display:block; font-size:0.8rem; font-weight:600; color:var(--gray-600); margin-bottom:0.3rem; }
        .form-group input, .form-group select {
            width:100%; padding:0.7rem; border:1.5px solid var(--gray-200);
            border-radius:10px; font-size:0.9rem; font-family:inherit;
            -webkit-appearance:none;
        }
        .form-group input:focus, .form-group select:focus {
            outline:none; border-color:var(--primary);
        }

        /* ===== Empty State ===== */
        .empty-state {
            text-align:center; padding:3rem 1rem; color:var(--gray-600);
        }
        .empty-state i { font-size:3rem; margin-bottom:1rem; opacity:0.3; }
        .empty-state p { font-size:0.9rem; }

        /* ===== Settings ===== */
        .setting-row {
            display:flex; justify-content:space-between; align-items:center;
            padding:1rem 0; border-bottom:1px solid var(--gray-100);
        }
        .setting-row:last-child { border-bottom:none; }
        .setting-label { font-weight:600; font-size:0.9rem; }
        .setting-desc { font-size:0.75rem; color:var(--gray-600); margin-top:0.15rem; }

        /* ===== Responsive ===== */
        @media (min-width:768px) {
            .app { padding:2rem; padding-bottom:5rem; }
            .summary-grid { grid-template-columns:repeat(4,1fr); }
            .portfolio-details { grid-template-columns:repeat(6,1fr); }
            .header h1 { font-size:1.5rem; }
        }
        @media (max-width:380px) {
            .app { padding:0.5rem; }
            .summary-value { font-size:1.2rem; }
            .header h1 { font-size:1rem; }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Quant System</h1>
                <p>AI Multi-Factor Platform</p>
            </div>
            <div class="header-right">
                <button class="btn btn-ghost btn-sm" onclick="exportData()"><i class="fas fa-download"></i></button>
                <button class="btn btn-ghost btn-sm" onclick="runStrategy()"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>

        <!-- ========== PAGE: Dashboard ========== -->
        <div id="page-dashboard" class="page active">
            <div class="summary-grid">
                <div class="summary-item green">
                    <div class="summary-label">Total P&L</div>
                    <div class="summary-value" id="totalPnl">0</div>
                </div>
                <div class="summary-item red">
                    <div class="summary-label">Total Return</div>
                    <div class="summary-value" id="totalReturn">0%</div>
                </div>
                <div class="summary-item blue">
                    <div class="summary-label">Invested</div>
                    <div class="summary-value" id="totalInvested">0</div>
                </div>
                <div class="summary-item purple">
                    <div class="summary-label">Current Value</div>
                    <div class="summary-value" id="totalValue">0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-chart-area"></i> Portfolio Performance</div>
                <div id="performanceChart" style="height:250px;"></div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-trophy"></i> Top Gainers / Losers</div>
                <div id="topMovers"></div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-chart-pie"></i> Sector Allocation</div>
                <div id="sectorChart" style="height:220px;"></div>
            </div>
        </div>

        <!-- ========== PAGE: My Portfolio (보유 종목) ========== -->
        <div id="page-portfolio" class="page">
            <div class="card">
                <div class="card-title" style="justify-content:space-between;">
                    <span><i class="fas fa-wallet"></i> My Portfolio</span>
                    <button class="btn btn-primary btn-sm" onclick="openAddStockModal()">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                <div id="portfolioList"></div>
            </div>
        </div>

        <!-- ========== PAGE: Buy Signals (매수 신호) ========== -->
        <div id="page-signals" class="page">
            <div class="card">
                <div class="card-title"><i class="fas fa-bolt"></i> AI Buy Signals</div>
                <p style="font-size:0.8rem; color:var(--gray-600); margin-bottom:1rem;">
                    Multi-factor analysis based recommendations. Tap to add to portfolio.
                </p>
                <div id="signalsList"></div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-chart-bar"></i> Factor Scores</div>
                <div id="factorChart" style="height:250px;"></div>
            </div>
        </div>

        <!-- ========== PAGE: Analysis ========== -->
        <div id="page-analysis" class="page">
            <div class="card">
                <div class="card-title"><i class="fas fa-microscope"></i> Portfolio Analysis</div>
                <div id="analysisChart" style="height:300px;"></div>
            </div>
            <div class="card">
                <div class="card-title"><i class="fas fa-balance-scale"></i> Risk Metrics</div>
                <div id="riskMetrics"></div>
            </div>
        </div>

        <!-- ========== PAGE: Settings ========== -->
        <div id="page-settings" class="page">
            <div class="card">
                <div class="card-title"><i class="fas fa-cog"></i> Settings</div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Currency</div>
                        <div class="setting-desc">Display currency for prices</div>
                    </div>
                    <select id="currencySetting" onchange="saveSetting('currency', this.value)" style="padding:0.4rem; border-radius:8px; border:1.5px solid var(--gray-200);">
                        <option value="KRW">KRW (&#8361;)</option>
                        <option value="USD">USD ($)</option>
                    </select>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Reset All Data</div>
                        <div class="setting-desc">Delete all portfolio data</div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="resetData()">Reset</button>
                </div>
            </div>
            <div class="card">
                <div class="card-title"><i class="fas fa-server"></i> Server Info</div>
                <div style="font-size:0.85rem; color:var(--gray-600); line-height:1.8;">
                    <p><strong>Hosting:</strong> GitHub Pages (Static)</p>
                    <p><strong>Backend Server:</strong> None (client-side only)</p>
                    <p><strong>Data Storage:</strong> Browser localStorage</p>
                    <p><strong>Charts:</strong> Plotly.js (client-side rendering)</p>
                    <p style="margin-top:0.75rem; padding:0.75rem; background:var(--gray-50); border-radius:8px;">
                        This app runs entirely in your browser. No server is needed.
                        All data is saved locally on your device. Different devices have separate data.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Tab Bar -->
    <nav class="tab-bar">
        <button class="tab-item active" onclick="switchPage('dashboard', this)">
            <i class="fas fa-home"></i><span>Dashboard</span>
        </button>
        <button class="tab-item" onclick="switchPage('portfolio', this)">
            <i class="fas fa-wallet"></i><span>My Stocks</span>
        </button>
        <button class="tab-item" onclick="switchPage('signals', this)">
            <i class="fas fa-bolt"></i><span>Buy Signal</span>
        </button>
        <button class="tab-item" onclick="switchPage('analysis', this)">
            <i class="fas fa-chart-bar"></i><span>Analysis</span>
        </button>
        <button class="tab-item" onclick="switchPage('settings', this)">
            <i class="fas fa-cog"></i><span>Settings</span>
        </button>
    </nav>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Add Stock Modal -->
    <div class="modal-overlay" id="addStockModal">
        <div class="modal">
            <span class="modal-handle"></span>
            <h3><i class="fas fa-plus-circle" style="color:var(--primary)"></i> Add to Portfolio</h3>
            <div class="form-group">
                <label>Symbol / Ticker</label>
                <input type="text" id="addSymbol" placeholder="e.g. AAPL, 005930" autocomplete="off">
            </div>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="addName" placeholder="e.g. Apple Inc.">
            </div>
            <div class="form-group">
                <label>Buy Price</label>
                <input type="number" id="addBuyPrice" placeholder="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="addQuantity" placeholder="0" step="1">
            </div>
            <div class="form-group">
                <label>Current Price</label>
                <input type="number" id="addCurrentPrice" placeholder="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Sector</label>
                <select id="addSector">
                    <option value="Tech">Tech</option>
                    <option value="Healthcare">Healthcare</option>
                    <option value="Finance">Finance</option>
                    <option value="Consumer">Consumer</option>
                    <option value="Energy">Energy</option>
                    <option value="Industrial">Industrial</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div style="display:flex; gap:0.75rem;">
                <button class="btn btn-primary" style="flex:1;" onclick="addStock()">Add Stock</button>
                <button class="btn btn-outline" style="flex:1;" onclick="closeAllModals()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Stock Modal -->
    <div class="modal-overlay" id="editStockModal">
        <div class="modal">
            <span class="modal-handle"></span>
            <h3><i class="fas fa-edit" style="color:var(--primary)"></i> Update Stock</h3>
            <input type="hidden" id="editIndex">
            <div class="form-group">
                <label>Current Price</label>
                <input type="number" id="editCurrentPrice" placeholder="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="editQuantity" placeholder="0" step="1">
            </div>
            <div style="display:flex; gap:0.75rem;">
                <button class="btn btn-primary" style="flex:1;" onclick="updateStock()">Update</button>
                <button class="btn btn-danger" style="flex:1;" onclick="sellStock()">
                    <i class="fas fa-sign-out-alt"></i> Sell (Remove)
                </button>
            </div>
            <button class="btn btn-outline" style="width:100%; margin-top:0.5rem;" onclick="closeAllModals()">Cancel</button>
        </div>
    </div>

    <!-- Signal Detail Modal -->
    <div class="modal-overlay" id="signalModal">
        <div class="modal">
            <span class="modal-handle"></span>
            <h3 id="signalModalTitle">Signal Detail</h3>
            <div id="signalModalContent"></div>
            <button class="btn btn-primary" style="width:100%; margin-top:1rem;" id="signalAddBtn">
                <i class="fas fa-plus"></i> Add to My Portfolio
            </button>
            <button class="btn btn-outline" style="width:100%; margin-top:0.5rem;" onclick="closeAllModals()">Close</button>
        </div>
    </div>

    <!-- Strategy Modal -->
    <div class="modal-overlay" id="strategyModal">
        <div class="modal">
            <span class="modal-handle"></span>
            <h3><i class="fas fa-rocket" style="color:var(--primary)"></i> Running Strategy</h3>
            <div style="width:100%;height:8px;background:var(--gray-200);border-radius:4px;overflow:hidden;margin:1rem 0;">
                <div id="progressFill" style="height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:4px;width:0%;transition:width 0.3s;"></div>
            </div>
            <div id="progressText" style="font-size:0.85rem;color:var(--gray-600);margin-bottom:0.75rem;">Initializing...</div>
            <div id="strategyLog" style="font-family:monospace;font-size:0.75rem;background:var(--gray-50);border-radius:8px;padding:0.75rem;max-height:180px;overflow-y:auto;color:var(--gray-700);line-height:1.8;"></div>
        </div>
    </div>

<script>
// ===== DATA =====
const STORAGE_KEY = 'quant_portfolio_v2';
const SETTINGS_KEY = 'quant_settings_v2';

// AI Buy Signals (recommendations)
const buySignals = [
    { symbol:'NVDA', name:'NVIDIA Corp.', sector:'Tech', score:0.95, targetPrice:950, currentPrice:880, reason:'AI/GPU demand surge, data center growth' },
    { symbol:'AAPL', name:'Apple Inc.', sector:'Tech', score:0.92, targetPrice:210, currentPrice:192, reason:'Services revenue growth, iPhone cycle' },
    { symbol:'MSFT', name:'Microsoft Corp.', sector:'Tech', score:0.89, targetPrice:440, currentPrice:415, reason:'Azure cloud + Copilot AI integration' },
    { symbol:'LLY', name:'Eli Lilly', sector:'Healthcare', score:0.88, targetPrice:850, currentPrice:780, reason:'GLP-1 drug pipeline dominance' },
    { symbol:'AMZN', name:'Amazon.com', sector:'Consumer', score:0.85, targetPrice:200, currentPrice:185, reason:'AWS growth + retail margin improvement' },
    { symbol:'META', name:'Meta Platforms', sector:'Tech', score:0.83, targetPrice:550, currentPrice:510, reason:'Ad revenue recovery, Reels monetization' },
    { symbol:'JPM', name:'JPMorgan Chase', sector:'Finance', score:0.80, targetPrice:210, currentPrice:195, reason:'Net interest income growth, strong balance sheet' },
    { symbol:'TSLA', name:'Tesla Inc.', sector:'Consumer', score:0.72, targetPrice:280, currentPrice:250, reason:'FSD progress, energy storage growth' },
];

function loadPortfolio() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
    catch { return []; }
}
function savePortfolio(data) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
function loadSettings() {
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || { currency:'USD' }; }
    catch { return { currency:'USD' }; }
}
function saveSetting(key, val) {
    const s = loadSettings(); s[key] = val;
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
    showToast('Setting saved', 'success');
    renderAll();
}

// ===== FORMATTING =====
function fmt(num) {
    const s = loadSettings();
    if (s.currency === 'KRW') return new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(num);
    return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2}).format(num);
}
function fmtPct(num) { return (num >= 0 ? '+' : '') + num.toFixed(2) + '%'; }
function pnlClass(v) { return v >= 0 ? 'pnl-positive' : 'pnl-negative'; }

// ===== TOAST =====
function showToast(msg, type='info') {
    const t = document.getElementById('toast');
    t.textContent = msg; t.className = 'toast ' + type;
    setTimeout(() => t.classList.add('show'), 10);
    setTimeout(() => t.classList.remove('show'), 2500);
}

// ===== PAGE SWITCHING =====
function switchPage(page, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    if (btn) btn.classList.add('active');
    renderAll();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ===== MODAL HELPERS =====
function closeAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show'));
}
document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', function(e) { if (e.target === this) closeAllModals(); });
});

// ===== PORTFOLIO CRUD =====
function openAddStockModal(prefill) {
    closeAllModals();
    if (prefill) {
        document.getElementById('addSymbol').value = prefill.symbol || '';
        document.getElementById('addName').value = prefill.name || '';
        document.getElementById('addCurrentPrice').value = prefill.currentPrice || '';
        document.getElementById('addBuyPrice').value = prefill.currentPrice || '';
        document.getElementById('addQuantity').value = '';
        document.getElementById('addSector').value = prefill.sector || 'Tech';
    } else {
        document.querySelectorAll('#addStockModal input').forEach(i => i.value = '');
    }
    document.getElementById('addStockModal').classList.add('show');
}

function addStock() {
    const symbol = document.getElementById('addSymbol').value.trim().toUpperCase();
    const name = document.getElementById('addName').value.trim();
    const buyPrice = parseFloat(document.getElementById('addBuyPrice').value);
    const qty = parseInt(document.getElementById('addQuantity').value);
    const currentPrice = parseFloat(document.getElementById('addCurrentPrice').value);
    const sector = document.getElementById('addSector').value;

    if (!symbol || !buyPrice || !qty || !currentPrice) {
        showToast('Please fill all required fields', 'error'); return;
    }

    const portfolio = loadPortfolio();
    portfolio.push({ symbol, name: name || symbol, buyPrice, quantity: qty, currentPrice, sector, addedDate: new Date().toISOString() });
    savePortfolio(portfolio);
    closeAllModals();
    showToast(symbol + ' added to portfolio!', 'success');
    renderAll();
}

function openEditModal(idx) {
    closeAllModals();
    const portfolio = loadPortfolio();
    const stock = portfolio[idx];
    document.getElementById('editIndex').value = idx;
    document.getElementById('editCurrentPrice').value = stock.currentPrice;
    document.getElementById('editQuantity').value = stock.quantity;
    document.getElementById('editStockModal').classList.add('show');
}

function updateStock() {
    const idx = parseInt(document.getElementById('editIndex').value);
    const portfolio = loadPortfolio();
    portfolio[idx].currentPrice = parseFloat(document.getElementById('editCurrentPrice').value);
    portfolio[idx].quantity = parseInt(document.getElementById('editQuantity').value);
    savePortfolio(portfolio);
    closeAllModals();
    showToast('Updated!', 'success');
    renderAll();
}

function sellStock() {
    const idx = parseInt(document.getElementById('editIndex').value);
    const portfolio = loadPortfolio();
    const symbol = portfolio[idx].symbol;
    if (confirm('Remove ' + symbol + ' from portfolio?')) {
        portfolio.splice(idx, 1);
        savePortfolio(portfolio);
        closeAllModals();
        showToast(symbol + ' sold/removed', 'success');
        renderAll();
    }
}

// ===== SIGNAL DETAIL =====
function showSignalDetail(signal) {
    closeAllModals();
    const upside = ((signal.targetPrice - signal.currentPrice) / signal.currentPrice * 100).toFixed(1);
    document.getElementById('signalModalTitle').innerHTML =
        '<span style="color:var(--primary)">' + signal.symbol + '</span> ' + signal.name;
    document.getElementById('signalModalContent').innerHTML =
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin:1rem 0;">' +
            '<div style="background:var(--gray-50);padding:0.8rem;border-radius:10px;">' +
                '<div style="font-size:0.7rem;color:var(--gray-600);">AI SCORE</div>' +
                '<div style="font-size:1.3rem;font-weight:800;color:var(--primary);">' + (signal.score * 100).toFixed(0) + '/100</div></div>' +
            '<div style="background:var(--gray-50);padding:0.8rem;border-radius:10px;">' +
                '<div style="font-size:0.7rem;color:var(--gray-600);">UPSIDE</div>' +
                '<div style="font-size:1.3rem;font-weight:800;color:var(--success);">+' + upside + '%</div></div>' +
            '<div style="background:var(--gray-50);padding:0.8rem;border-radius:10px;">' +
                '<div style="font-size:0.7rem;color:var(--gray-600);">CURRENT</div>' +
                '<div style="font-size:1.3rem;font-weight:800;">' + fmt(signal.currentPrice) + '</div></div>' +
            '<div style="background:var(--gray-50);padding:0.8rem;border-radius:10px;">' +
                '<div style="font-size:0.7rem;color:var(--gray-600);">TARGET</div>' +
                '<div style="font-size:1.3rem;font-weight:800;color:var(--success);">' + fmt(signal.targetPrice) + '</div></div>' +
        '</div>' +
        '<div style="background:var(--gray-50);padding:0.8rem;border-radius:10px;font-size:0.85rem;color:var(--gray-700);">' +
            '<strong>Analysis:</strong> ' + signal.reason + '</div>';

    document.getElementById('signalAddBtn').onclick = function() {
        closeAllModals();
        openAddStockModal(signal);
    };
    document.getElementById('signalModal').classList.add('show');
}

// ===== RENDER =====
function renderAll() {
    renderDashboard();
    renderPortfolio();
    renderSignals();
    renderAnalysis();
    const settings = loadSettings();
    document.getElementById('currencySetting').value = settings.currency;
}

function renderDashboard() {
    const portfolio = loadPortfolio();
    let totalInvested = 0, totalCurrent = 0;
    portfolio.forEach(s => {
        totalInvested += s.buyPrice * s.quantity;
        totalCurrent += s.currentPrice * s.quantity;
    });
    const totalPnl = totalCurrent - totalInvested;
    const totalReturnPct = totalInvested > 0 ? (totalPnl / totalInvested * 100) : 0;

    document.getElementById('totalPnl').textContent = fmt(totalPnl);
    document.getElementById('totalPnl').className = 'summary-value ' + pnlClass(totalPnl);
    document.getElementById('totalReturn').textContent = fmtPct(totalReturnPct);
    document.getElementById('totalReturn').className = 'summary-value ' + pnlClass(totalReturnPct);
    document.getElementById('totalInvested').textContent = fmt(totalInvested);
    document.getElementById('totalInvested').className = 'summary-value';
    document.getElementById('totalValue').textContent = fmt(totalCurrent);
    document.getElementById('totalValue').className = 'summary-value';

    // Top movers
    const movers = document.getElementById('topMovers');
    if (portfolio.length === 0) {
        movers.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>Add stocks to see top movers</p></div>';
    } else {
        const sorted = [...portfolio].map((s, i) => ({ ...s, idx: i, returnPct: (s.currentPrice - s.buyPrice) / s.buyPrice * 100 }));
        sorted.sort((a, b) => b.returnPct - a.returnPct);
        const top = sorted.slice(0, 3);
        const bottom = sorted.slice(-3).reverse();
        let html = '';
        [...top, ...bottom].forEach(s => {
            html += '<div class="stock-item" onclick="openEditModal(' + s.idx + ')">' +
                '<div class="stock-left"><div class="stock-symbol">' + s.symbol.slice(0,4) + '</div>' +
                '<div><div class="stock-name">' + s.symbol + '</div><div class="stock-sub">' + s.name + '</div></div></div>' +
                '<div class="stock-right"><div class="stock-price">' + fmt(s.currentPrice) + '</div>' +
                '<div class="stock-change ' + (s.returnPct >= 0 ? 'up' : 'down') + '">' + fmtPct(s.returnPct) + '</div></div></div>';
        });
        movers.innerHTML = html;
    }

    // Performance chart
    renderPerformanceChart(portfolio);

    // Sector chart
    renderSectorChart(portfolio);
}

function renderPerformanceChart(portfolio) {
    if (portfolio.length === 0) {
        Plotly.newPlot('performanceChart', [], { margin:{t:20,r:10,b:30,l:50}, xaxis:{visible:false}, yaxis:{visible:false},
            annotations:[{text:'Add stocks to see chart',showarrow:false,font:{size:14,color:'#9ca3af'}}],
            plot_bgcolor:'transparent', paper_bgcolor:'transparent' }, {responsive:true, displayModeBar:false});
        return;
    }
    // Simulate portfolio value over time
    const days = 60;
    const dates = [], values = [];
    let totalQty = portfolio.reduce((s, p) => s + p.quantity, 0);
    let baseValue = portfolio.reduce((s, p) => s + p.buyPrice * p.quantity, 0);
    for (let i = 0; i < days; i++) {
        const d = new Date(); d.setDate(d.getDate() - (days - i));
        dates.push(d.toISOString().split('T')[0]);
        baseValue *= (1 + (Math.random() - 0.47) * 0.015);
        values.push(baseValue);
    }
    // Set last value to actual current value
    values[values.length - 1] = portfolio.reduce((s, p) => s + p.currentPrice * p.quantity, 0);

    Plotly.newPlot('performanceChart', [{
        x: dates, y: values, type:'scatter', mode:'lines',
        line:{color:'#6366f1',width:2.5}, fill:'tozeroy', fillcolor:'rgba(99,102,241,0.08)'
    }], {
        margin:{t:10,r:10,b:30,l:50},
        xaxis:{gridcolor:'#f3f4f6',showgrid:false},
        yaxis:{gridcolor:'#f3f4f6',tickformat:',.0f'},
        plot_bgcolor:'transparent', paper_bgcolor:'transparent'
    }, {responsive:true, displayModeBar:false});
}

function renderSectorChart(portfolio) {
    if (portfolio.length === 0) {
        Plotly.newPlot('sectorChart', [], { margin:{t:10,r:10,b:10,l:10},
            annotations:[{text:'No data',showarrow:false,font:{size:14,color:'#9ca3af'}}],
            plot_bgcolor:'transparent', paper_bgcolor:'transparent' }, {responsive:true, displayModeBar:false});
        return;
    }
    const sectors = {};
    portfolio.forEach(s => { sectors[s.sector] = (sectors[s.sector]||0) + s.currentPrice * s.quantity; });
    Plotly.newPlot('sectorChart', [{
        values: Object.values(sectors), labels: Object.keys(sectors),
        type:'pie', hole:0.55,
        marker:{colors:['#6366f1','#8b5cf6','#ec4899','#3b82f6','#10b981','#f59e0b','#6b7280']},
        textinfo:'label+percent', textfont:{size:11}
    }], { margin:{t:10,r:10,b:10,l:10}, showlegend:false, plot_bgcolor:'transparent', paper_bgcolor:'transparent'
    }, {responsive:true, displayModeBar:false});
}

function renderPortfolio() {
    const portfolio = loadPortfolio();
    const container = document.getElementById('portfolioList');

    if (portfolio.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-wallet"></i>' +
            '<p>No stocks yet</p><p style="font-size:0.8rem;margin-top:0.5rem;">Tap the + button or add from Buy Signals</p></div>';
        return;
    }

    let html = '';
    portfolio.forEach((s, idx) => {
        const pnl = (s.currentPrice - s.buyPrice) * s.quantity;
        const returnPct = (s.currentPrice - s.buyPrice) / s.buyPrice * 100;
        const totalValue = s.currentPrice * s.quantity;

        html += '<div class="portfolio-item" onclick="openEditModal(' + idx + ')">' +
            '<div class="portfolio-top">' +
                '<div class="stock-left"><div class="stock-symbol">' + s.symbol.slice(0,4) + '</div>' +
                '<div><div class="stock-name">' + s.symbol + '</div><div class="stock-sub">' + s.name + '</div></div></div>' +
                '<div class="stock-right">' +
                    '<div class="stock-price ' + pnlClass(pnl) + '">' + fmt(pnl) + '</div>' +
                    '<div class="stock-change ' + (returnPct >= 0 ? 'up' : 'down') + '">' + fmtPct(returnPct) + '</div>' +
                '</div>' +
            '</div>' +
            '<div class="portfolio-details">' +
                '<div><div class="portfolio-detail-label">Buy Price</div><div class="portfolio-detail-value">' + fmt(s.buyPrice) + '</div></div>' +
                '<div><div class="portfolio-detail-label">Current</div><div class="portfolio-detail-value">' + fmt(s.currentPrice) + '</div></div>' +
                '<div><div class="portfolio-detail-label">Qty</div><div class="portfolio-detail-value">' + s.quantity + '</div></div>' +
            '</div>' +
        '</div>';
    });
    container.innerHTML = html;
}

function renderSignals() {
    const container = document.getElementById('signalsList');
    let html = '';
    buySignals.forEach(signal => {
        const upside = ((signal.targetPrice - signal.currentPrice) / signal.currentPrice * 100).toFixed(1);
        const badgeClass = signal.score >= 0.9 ? 'badge-strong' : signal.score >= 0.8 ? 'badge-buy' : 'badge-hold';
        const badgeText = signal.score >= 0.9 ? 'Strong Buy' : signal.score >= 0.8 ? 'Buy' : 'Hold';

        html += '<div class="stock-item" onclick=\'showSignalDetail(' + JSON.stringify(signal) + ')\'>' +
            '<div class="stock-left"><div class="stock-symbol">' + signal.symbol.slice(0,4) + '</div>' +
            '<div><div class="stock-name">' + signal.symbol + ' <span class="badge ' + badgeClass + '">' + badgeText + '</span></div>' +
            '<div class="stock-sub">' + signal.name + '</div></div></div>' +
            '<div class="stock-right"><div class="stock-price">' + fmt(signal.currentPrice) + '</div>' +
            '<div class="stock-change up">+' + upside + '% upside</div></div></div>';
    });
    container.innerHTML = html;

    // Factor chart
    Plotly.newPlot('factorChart', [{
        x:[8.5, 7.2, 6.8, 5.5, 4.1],
        y:['Momentum','Quality','Growth','Value','Low Vol'],
        type:'bar', orientation:'h',
        marker:{color:['#6366f1','#8b5cf6','#3b82f6','#10b981','#f59e0b']},
        text:['8.5','7.2','6.8','5.5','4.1'], textposition:'outside'
    }], {
        margin:{t:10,r:40,b:30,l:80},
        xaxis:{gridcolor:'#f3f4f6',title:'Score'},
        plot_bgcolor:'transparent', paper_bgcolor:'transparent'
    }, {responsive:true, displayModeBar:false});
}

function renderAnalysis() {
    const portfolio = loadPortfolio();
    if (portfolio.length === 0) {
        Plotly.newPlot('analysisChart', [], {
            margin:{t:20,r:10,b:30,l:50},
            annotations:[{text:'Add stocks to see analysis',showarrow:false,font:{size:14,color:'#9ca3af'}}],
            plot_bgcolor:'transparent', paper_bgcolor:'transparent'
        }, {responsive:true, displayModeBar:false});
        document.getElementById('riskMetrics').innerHTML = '<div class="empty-state"><i class="fas fa-chart-line"></i><p>No data to analyze</p></div>';
        return;
    }

    // Return distribution
    const returns = portfolio.map(s => ((s.currentPrice - s.buyPrice) / s.buyPrice * 100));
    Plotly.newPlot('analysisChart', [{
        x: portfolio.map(s => s.symbol), y: returns, type:'bar',
        marker:{color: returns.map(r => r >= 0 ? '#10b981' : '#ef4444')},
        text: returns.map(r => fmtPct(r)), textposition:'outside'
    }], {
        margin:{t:10,r:10,b:40,l:50}, xaxis:{title:''},
        yaxis:{title:'Return (%)',gridcolor:'#f3f4f6'},
        plot_bgcolor:'transparent', paper_bgcolor:'transparent'
    }, {responsive:true, displayModeBar:false});

    // Risk metrics
    const avgReturn = returns.reduce((a,b)=>a+b,0) / returns.length;
    const maxReturn = Math.max(...returns);
    const minReturn = Math.min(...returns);
    const winRate = (returns.filter(r=>r>=0).length / returns.length * 100).toFixed(0);
    const totalValue = portfolio.reduce((s,p) => s + p.currentPrice * p.quantity, 0);
    const maxPosition = Math.max(...portfolio.map(p => p.currentPrice * p.quantity));
    const concentration = (maxPosition / totalValue * 100).toFixed(1);

    document.getElementById('riskMetrics').innerHTML =
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">' +
            '<div style="background:var(--gray-50);padding:0.8rem;border-radius:10px;">' +
                '<div style="font-size:0.7rem;color:var(--gray-600);">AVG RETURN</div>' +
                '<div style="font-size:1.2rem;font-weight:800;" class="' + pnlClass(avgReturn) + '">' + fmtPct(avgReturn) + '</div></div>' +
            '<div style="background:var(--gray-50);padding:0.8rem;border-radius:10px;">' +
                '<div style="font-size:0.7rem;color:var(--gray-600);">WIN RATE</div>' +
                '<div style="font-size:1.2rem;font-weight:800;color:var(--primary);">' + winRate + '%</div></div>' +
            '<div style="background:var(--gray-50);padding:0.8rem;border-radius:10px;">' +
                '<div style="font-size:0.7rem;color:var(--gray-600);">BEST</div>' +
                '<div style="font-size:1.2rem;font-weight:800;color:var(--success);">' + fmtPct(maxReturn) + '</div></div>' +
            '<div style="background:var(--gray-50);padding:0.8rem;border-radius:10px;">' +
                '<div style="font-size:0.7rem;color:var(--gray-600);">WORST</div>' +
                '<div style="font-size:1.2rem;font-weight:800;color:var(--danger);">' + fmtPct(minReturn) + '</div></div>' +
            '<div style="background:var(--gray-50);padding:0.8rem;border-radius:10px;">' +
                '<div style="font-size:0.7rem;color:var(--gray-600);">POSITIONS</div>' +
                '<div style="font-size:1.2rem;font-weight:800;">' + portfolio.length + '</div></div>' +
            '<div style="background:var(--gray-50);padding:0.8rem;border-radius:10px;">' +
                '<div style="font-size:0.7rem;color:var(--gray-600);">TOP CONCENTRATION</div>' +
                '<div style="font-size:1.2rem;font-weight:800;">' + concentration + '%</div></div>' +
        '</div>';
}

// ===== EXPORT =====
function exportData() {
    const portfolio = loadPortfolio();
    if (portfolio.length === 0) { showToast('No data to export', 'error'); return; }
    const csv = ['Symbol,Name,BuyPrice,CurrentPrice,Quantity,P&L,Return%,Sector'];
    portfolio.forEach(s => {
        const pnl = (s.currentPrice - s.buyPrice) * s.quantity;
        const ret = ((s.currentPrice - s.buyPrice) / s.buyPrice * 100).toFixed(2);
        csv.push([s.symbol, s.name, s.buyPrice, s.currentPrice, s.quantity, pnl.toFixed(2), ret+'%', s.sector].join(','));
    });
    const blob = new Blob([csv.join('\n')], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'portfolio_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    showToast('CSV exported!', 'success');
}

// ===== RUN STRATEGY =====
function runStrategy() {
    closeAllModals();
    const modal = document.getElementById('strategyModal');
    const fill = document.getElementById('progressFill');
    const text = document.getElementById('progressText');
    const log = document.getElementById('strategyLog');
    modal.classList.add('show');
    fill.style.width = '0%'; log.innerHTML = '';

    const steps = [
        {pct:12, msg:'Loading market data...'},
        {pct:28, msg:'Calculating factor scores...'},
        {pct:45, msg:'Running ML prediction models...'},
        {pct:62, msg:'Generating alpha signals...'},
        {pct:78, msg:'Optimizing portfolio weights...'},
        {pct:92, msg:'Risk analysis complete'},
        {pct:100, msg:'Done! Signals updated.'}
    ];
    steps.forEach((step, i) => {
        setTimeout(() => {
            fill.style.width = step.pct + '%';
            text.textContent = step.msg;
            log.innerHTML += '<div>' + new Date().toLocaleTimeString() + ' ' + step.msg + '</div>';
            log.scrollTop = log.scrollHeight;
            if (i === steps.length - 1) {
                setTimeout(() => {
                    showToast('Strategy complete! Check Buy Signals.', 'success');
                }, 400);
            }
        }, (i+1) * 500);
    });
}

// ===== RESET =====
function resetData() {
    if (confirm('Delete all portfolio data? This cannot be undone.')) {
        localStorage.removeItem(STORAGE_KEY);
        showToast('All data cleared', 'success');
        renderAll();
    }
}

// ===== INIT =====
renderAll();
</script>
</body>
</html>
